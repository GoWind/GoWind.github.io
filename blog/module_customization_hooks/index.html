<!DOCTYPE html><html lang="en" data-astro-cid-bvzihdzo> <head><!-- Global Metadata --><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1"><link rel="icon" type="image/svg+xml" href="/favicon.svg"><meta name="generator" content="Astro v5.9.1"><!-- Font preloads --><link rel="preload" href="/fonts/atkinson-regular.woff" as="font" type="font/woff" crossorigin><link rel="preload" href="/fonts/atkinson-bold.woff" as="font" type="font/woff" crossorigin><link rel="preload" href="/fonts/saiyan_sans/Saiyan-Sans.ttf" as="font" type="font/ttf" crossorigin><!-- Canonical URL --><link rel="canonical" href="https://gowind.github.io/blog/module_customization_hooks/"><!-- Primary Meta Tags --><title>Module customization hooks in Node 20</title><meta name="title" content="Module customization hooks in Node 20"><meta name="description" content="How module resolution works in Node JS"><!-- Open Graph / Facebook --><meta property="og:type" content="website"><meta property="og:url" content="https://gowind.github.io/blog/module_customization_hooks/"><meta property="og:title" content="Module customization hooks in Node 20"><meta property="og:description" content="How module resolution works in Node JS"><meta property="og:image" content="https://gowind.github.io/blog-placeholder-1.jpg"><!-- Twitter --><meta property="twitter:card" content="summary_large_image"><meta property="twitter:url" content="https://gowind.github.io/blog/module_customization_hooks/"><meta property="twitter:title" content="Module customization hooks in Node 20"><meta property="twitter:description" content="How module resolution works in Node JS"><meta property="twitter:image" content="https://gowind.github.io/blog-placeholder-1.jpg"><!-- Cloudflare Web Analytics --><script defer src="https://static.cloudflareinsights.com/beacon.min.js" data-cf-beacon="{&quot;token&quot;: &quot;4de85a62d838459fafd8a042c2f1c7c2&quot;}"></script><!-- End Cloudflare Web Analytics --><link rel="stylesheet" href="/js/_slug_.DOYIKLAD.css">
<style>a[data-astro-cid-eimmu3lg]{display:inline-block;text-decoration:none}a[data-astro-cid-eimmu3lg].active{font-weight:bolder;text-decoration:underline}
.scrollrectangle[data-astro-cid-bvzihdzo]{position:fixed;right:20px;width:20px;height:100px;background-color:#2c65d7;border-radius:10%;transition:top .3s ease-out;transform-origin:center center;animation:squeeze 1s infinite}@keyframes squeeze{0%{transform:scaleY(1)}50%{transform:scaleY(1.5)}to{transform:scaleY(1)}}main[data-astro-cid-bvzihdzo]{width:calc(100% - 2em);max-width:100%;margin:0}.hero-image[data-astro-cid-bvzihdzo]{width:100%}.hero-image[data-astro-cid-bvzihdzo] img[data-astro-cid-bvzihdzo]{display:block;margin:0 auto;border-radius:12px;box-shadow:var(--box-shadow)}.prose[data-astro-cid-bvzihdzo]{width:720px;max-width:calc(100% - 2em);margin:auto;padding:1em;color:rgb(var(--gray-dark))}.title[data-astro-cid-bvzihdzo]{margin-bottom:1em;padding:1em 0;text-align:center;line-height:1}.title[data-astro-cid-bvzihdzo] h1[data-astro-cid-bvzihdzo]{margin:0 0 .5em}.date[data-astro-cid-bvzihdzo]{margin-bottom:.5em;color:rgb(var(--gray))}.last-updated-on[data-astro-cid-bvzihdzo]{font-style:italic}
</style></head> <body data-astro-cid-bvzihdzo> <header data-astro-cid-3ef6ksr2> <nav data-astro-cid-3ef6ksr2> <div class="aura-container" data-astro-cid-3ef6ksr2> <div class="gif-bg-1" data-astro-cid-3ef6ksr2></div> <div class="gif-bg-2" data-astro-cid-3ef6ksr2></div> <div class="gif-bg-3" data-astro-cid-3ef6ksr2></div> <h2 class="aura-text" data-astro-cid-3ef6ksr2> <a href="/" data-astro-cid-3ef6ksr2> <span class="yellow" data-astro-cid-3ef6ksr2>Govind's</span> <span class="orange" data-astro-cid-3ef6ksr2>O</span> <span data-astro-cid-3ef6ksr2>Blog</span> </a></h2> </div> <div class="internal-links" data-astro-cid-3ef6ksr2> <a href="/" data-astro-cid-3ef6ksr2="true" data-astro-cid-eimmu3lg> Home </a>  <a href="/blog" class="active" data-astro-cid-3ef6ksr2="true" data-astro-cid-eimmu3lg> Blog </a>  <a href="/ideas" data-astro-cid-3ef6ksr2="true" data-astro-cid-eimmu3lg> Steal My Ideas </a>  <a href="/editor" data-astro-cid-3ef6ksr2="true" data-astro-cid-eimmu3lg> Image Editor </a>  </div> <div class="social-links" data-astro-cid-3ef6ksr2> <a href="https://x.com/DeepknowledgeU" target="_blank" data-astro-cid-3ef6ksr2> <span class="sr-only" data-astro-cid-3ef6ksr2>Follow Astro on X</span> <svg viewBox="0 0 16 16" aria-hidden="true" width="32" height="32" astro-icon="social/twitter" data-astro-cid-3ef6ksr2><path fill="currentColor" d="M5.026 15c6.038 0 9.341-5.003 9.341-9.334 0-.14 0-.282-.006-.422A6.685 6.685 0 0 0 16 3.542a6.658 6.658 0 0 1-1.889.518 3.301 3.301 0 0 0 1.447-1.817 6.533 6.533 0 0 1-2.087.793A3.286 3.286 0 0 0 7.875 6.03a9.325 9.325 0 0 1-6.767-3.429 3.289 3.289 0 0 0 1.018 4.382A3.323 3.323 0 0 1 .64 6.575v.045a3.288 3.288 0 0 0 2.632 3.218 3.203 3.203 0 0 1-.865.115 3.23 3.23 0 0 1-.614-.057 3.283 3.283 0 0 0 3.067 2.277A6.588 6.588 0 0 1 .78 13.58a6.32 6.32 0 0 1-.78-.045A9.344 9.344 0 0 0 5.026 15z" data-astro-cid-3ef6ksr2></path></svg> </a> <a href="https://github.com/Gowind" target="_blank" data-astro-cid-3ef6ksr2> <span class="sr-only" data-astro-cid-3ef6ksr2>My Github</span> <svg viewBox="0 0 16 16" aria-hidden="true" width="32" height="32" astro-icon="social/github" data-astro-cid-3ef6ksr2><path fill="currentColor" d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.012 8.012 0 0 0 16 8c0-4.42-3.58-8-8-8z" data-astro-cid-3ef6ksr2></path></svg> </a> </div> </nav> </header>  <main data-astro-cid-bvzihdzo> <article data-astro-cid-bvzihdzo> <div class="scrollrectangle" data-astro-cid-bvzihdzo></div> <script type="module">const o=document.querySelector(".ball"),c=document.querySelector("header"),r=document.documentElement.scrollHeight-window.innerHeight,t=c?.offsetHeight;o.style.top=`${t+100}px`;window.addEventListener("scroll",()=>{const n=window.scrollY/r,l=window.innerHeight-100;let e=n*l;e=e>=t+100?e:t+100,o.style.top=`${e}px`});</script> <div class="hero-image" data-astro-cid-bvzihdzo>  </div> <div class="prose" data-astro-cid-bvzihdzo> <div class="title" data-astro-cid-bvzihdzo> <div class="date" data-astro-cid-bvzihdzo> <time datetime="2023-11-02T00:00:00.000Z"> Nov 2, 2023 </time>  </div> <h1 data-astro-cid-bvzihdzo>Module customization hooks in Node 20</h1> <hr data-astro-cid-bvzihdzo> </div>  <p>Node 20 changed/added behaviour to handle <code>import</code> statements in <code>.js</code> files.
We will go through some code to see how it works.</p>
<h3 id="no-type-module-in-packagejson">No <code>type: module</code> in <code>package.json</code></h3>
<ol>
<li><code>import</code> statements in <code>.js</code> files won’t work.</li>
</ol>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="plaintext"><code><span class="line"><span></span></span>
<span class="line"><span>$ cat my-app.js</span></span>
<span class="line"><span>import { hello } from './my-app-x';</span></span>
<span class="line"><span>import crypto from "node:crypto";</span></span>
<span class="line"><span>console.log(hello());</span></span>
<span class="line"><span>console.log(crypto.randomBytes(32).toString('hex'));</span></span></code></pre>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="plaintext"><code><span class="line"><span>~/personal/node_hooks ⌚ 22:28:57</span></span>
<span class="line"><span>$ cat my-app-x.js</span></span>
<span class="line"><span>export function hello() {</span></span>
<span class="line"><span>  return 4;</span></span>
<span class="line"><span>}</span></span></code></pre>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="plaintext"><code><span class="line"><span>~/personal/node_hooks ⌚ 22:29:04</span></span>
<span class="line"><span>$ node my-app.js</span></span>
<span class="line"><span>(node:58013) Warning: To load an ES module, set "type": "module" in the package.json or use the .mjs extension.</span></span>
<span class="line"><span>(Use `node --trace-warnings ...` to show where the warning was created)</span></span>
<span class="line"><span>/Users/govind/personal/node_hooks/my-app.js:1</span></span>
<span class="line"><span>import { hello } from './my-app-x';</span></span>
<span class="line"><span>^^^^^^</span></span></code></pre>
<h4 id="solution-change-js-files-to-mjs-files-and-rename-import-specifiers--to-work-with-modules">Solution: change <code>.js</code> files to <code>.mjs</code> files (and rename import <code>specifiers</code> ) to work with modules</h4>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="plaintext"><code><span class="line"><span>$ cat my-app.mjs</span></span>
<span class="line"><span>import { hello } from './my-app-x.mjs';</span></span>
<span class="line"><span>import crypto from "node:crypto";</span></span>
<span class="line"><span>console.log(hello());</span></span>
<span class="line"><span>console.log(crypto.randomBytes(32).toString('hex'));</span></span>
<span class="line"><span></span></span>
<span class="line"><span>~/personal/node_hooks ⌚ 22:37:34</span></span>
<span class="line"><span>$ cat my-app-x.mjs</span></span>
<span class="line"><span>export function hello() {</span></span>
<span class="line"><span>  return 4;</span></span>
<span class="line"><span>}</span></span>
<span class="line"><span></span></span>
<span class="line"><span>~/personal/node_hooks ⌚ 22:37:38</span></span>
<span class="line"><span>$ node my-app.mjs</span></span>
<span class="line"><span>4</span></span>
<span class="line"><span>0ad44de8f3ffa9e769f593b9228c13e7b765c78aa50b3e3909c991bb96aaee1f</span></span></code></pre>
<h3 id="adding-type-module-in-packagejson">Adding <code>type: module</code> in package.json</h3>
<p>Will allow you to use <code>import</code> statements within <code>.js</code> files</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="plaintext"><code><span class="line"><span>node my-app.js</span></span>
<span class="line"><span>node:internal/process/esm_loader:48</span></span>
<span class="line"><span>      internalBinding('errors').triggerUncaughtException(</span></span>
<span class="line"><span>                                ^</span></span>
<span class="line"><span></span></span>
<span class="line"><span>Error [ERR_MODULE_NOT_FOUND]: Cannot find module '/Users/govind/personal/node_hooks/my-app-x' imported from /Users/govind/personal/node_hooks/my-app.js</span></span>
<span class="line"><span>Did you mean to import ../my-app-x.js?</span></span></code></pre>
<p><strong>However, You cannot import from js modules (that are single files) without a <code>.js</code> suffix</strong></p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="plaintext"><code><span class="line"><span>$ cat my-app.js</span></span>
<span class="line"><span>import { hello } from './my-app-x.js';</span></span>
<span class="line"><span>import crypto from "node:crypto";</span></span>
<span class="line"><span>console.log(hello());</span></span>
<span class="line"><span>console.log(crypto.randomBytes(32).toString('hex'));</span></span>
<span class="line"><span></span></span>
<span class="line"><span>~/personal/node_hooks ⌚ 22:33:30</span></span>
<span class="line"><span>$ node my-app.js</span></span>
<span class="line"><span>4</span></span>
<span class="line"><span>b287ab28bd13f778ffb49df44c7a5eac942e119fee786b6f9a196b21aa497ceb</span></span></code></pre>
<p><strong>The solutions work fine for new code , but what about existing JS code where you might already be using js modules without a <code>.js</code> suffix in the code ?</strong></p>
<h3 id="module-customization-hooks">Module customization hooks</h3>
<p>You can use <a href="https://nodejs.org/docs/latest-v20.x/api/module.html#customization-hooks">Module customization hook</a> to customize module resolution and loading.
The hook is provided in a <code>.mjs</code>/<code>.js</code> that is run in a separate thread , before your entry file is executed.
The hook is executed as thus:</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="plaintext"><code><span class="line"><span>```bash</span></span>
<span class="line"><span>node --import ./register-hooks.js ./my-app.js</span></span></code></pre>
<p>Where <code>register-hooks</code> calls the <code>register</code> method of <code>node:module</code> builtin with the path to a file containing the hooks</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="plaintext"><code><span class="line"><span>const { register } = require('node:module');</span></span>
<span class="line"><span>const { pathToFileURL } = require('node:url');</span></span>
<span class="line"><span></span></span>
<span class="line"><span>const { port1, port2 } = new MessageChannel();</span></span>
<span class="line"><span></span></span>
<span class="line"><span>const pfUrl = pathToFileURL(__filename);</span></span>
<span class="line"><span>console.log(pfUrl);</span></span>
<span class="line"><span>register('./hooks.mjs', {parentURL: pfUrl.href, data: {number: 1, port: port2 }, transferList: [port2]});</span></span></code></pre>
<p>The <code>hooks.mjs</code> exports 3 fns: <code>initialize</code>, <code>resolve</code> and <code>load</code> that will allow you to resolve import specifiers (<code>./my-app</code> or <code>crypto</code> or <code>@package/some-name</code> etc) and then allow you to customize how they are loaded
You will find a sample implementation <a href="https://github.com/GoWind/algorithms/tree/master/node_hooks">here</a>.</p>
<p>I <a href="https://github.com/GoWind/algorithms/tree/master/node_hooks">customized</a> the hooks to import es modules with a <code>.mjs</code> or a <code>type</code>: “module” in package.json.</p>
<p>The output is something like this</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="plaintext"><code><span class="line"><span>$ node --import ./register-hooks.cjs ./my-app.js</span></span>
<span class="line"><span>URL {</span></span>
<span class="line"><span>  href: 'file:///Users/govind/personal/algorithms/node_hooks/register-hooks.cjs',</span></span>
<span class="line"><span>  origin: 'null',</span></span>
<span class="line"><span>  protocol: 'file:',</span></span>
<span class="line"><span>  username: '',</span></span>
<span class="line"><span>  password: '',</span></span>
<span class="line"><span>  host: '',</span></span>
<span class="line"><span>  hostname: '',</span></span>
<span class="line"><span>  port: '',</span></span>
<span class="line"><span>  pathname: '/Users/govind/personal/algorithms/node_hooks/register-hooks.cjs',</span></span>
<span class="line"><span>  search: '',</span></span>
<span class="line"><span>  searchParams: URLSearchParams {},</span></span>
<span class="line"><span>  hash: ''</span></span>
<span class="line"><span>}</span></span>
<span class="line"><span>got file:///Users/govind/personal/algorithms/node_hooks/my-app.js to resolve</span></span>
<span class="line"><span>calling load for file:///Users/govind/personal/algorithms/node_hooks/my-app.js</span></span>
<span class="line"><span>got ./my-app-x to resolve</span></span>
<span class="line"><span>got node:crypto to resolve</span></span>
<span class="line"><span>calling load for file:///Users/govind/personal/algorithms/node_hooks/my-app-x.js</span></span>
<span class="line"><span>calling load for node:crypto</span></span>
<span class="line"><span>4</span></span>
<span class="line"><span>32a902c4ec08d14308ed0ac00b5e2340b31dd298e964e07a4635997939e5041b</span></span></code></pre>
<p>Happy hacking !</p>  </div> </article> </main> <footer data-astro-cid-sz7xmlte> <div class="social-links" data-astro-cid-sz7xmlte> <a href="https://x.com/DeepknowledgeU" target="_blank" data-astro-cid-sz7xmlte> <span class="sr-only" data-astro-cid-sz7xmlte>Follow Astro on X</span> <svg viewBox="0 0 16 16" aria-hidden="true" width="32" height="32" astro-icon="social/twitter" data-astro-cid-sz7xmlte><path fill="currentColor" d="M5.026 15c6.038 0 9.341-5.003 9.341-9.334 0-.14 0-.282-.006-.422A6.685 6.685 0 0 0 16 3.542a6.658 6.658 0 0 1-1.889.518 3.301 3.301 0 0 0 1.447-1.817 6.533 6.533 0 0 1-2.087.793A3.286 3.286 0 0 0 7.875 6.03a9.325 9.325 0 0 1-6.767-3.429 3.289 3.289 0 0 0 1.018 4.382A3.323 3.323 0 0 1 .64 6.575v.045a3.288 3.288 0 0 0 2.632 3.218 3.203 3.203 0 0 1-.865.115 3.23 3.23 0 0 1-.614-.057 3.283 3.283 0 0 0 3.067 2.277A6.588 6.588 0 0 1 .78 13.58a6.32 6.32 0 0 1-.78-.045A9.344 9.344 0 0 0 5.026 15z" data-astro-cid-sz7xmlte></path></svg> </a> <a href="https://github.com/Gowind" target="_blank" data-astro-cid-sz7xmlte> <span class="sr-only" data-astro-cid-sz7xmlte>My Github</span> <svg viewBox="0 0 16 16" aria-hidden="true" width="32" height="32" astro-icon="social/github" data-astro-cid-sz7xmlte><path fill="currentColor" d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.012 8.012 0 0 0 16 8c0-4.42-3.58-8-8-8z" data-astro-cid-sz7xmlte></path></svg> </a> </div> </footer>  </body></html>