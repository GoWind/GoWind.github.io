<!DOCTYPE html><html lang="en" data-astro-cid-bvzihdzo> <head><!-- Global Metadata --><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1"><link rel="icon" type="image/svg+xml" href="/favicon.svg"><meta name="generator" content="Astro v5.15.9"><!-- Font preloads --><link rel="preload" href="/fonts/atkinson-regular.woff" as="font" type="font/woff" crossorigin><link rel="preload" href="/fonts/atkinson-bold.woff" as="font" type="font/woff" crossorigin><link rel="preload" href="/fonts/saiyan_sans/Saiyan-Sans.ttf" as="font" type="font/ttf" crossorigin><!-- Canonical URL --><link rel="canonical" href="https://gowind.github.io/blog/promise_part2/"><!-- Primary Meta Tags --><title>Deep dive into Promises - Part II</title><meta name="title" content="Deep dive into Promises - Part II"><meta name="description" content="Static methods on Promises"><!-- Open Graph / Facebook --><meta property="og:type" content="website"><meta property="og:url" content="https://gowind.github.io/blog/promise_part2/"><meta property="og:title" content="Deep dive into Promises - Part II"><meta property="og:description" content="Static methods on Promises"><meta property="og:image" content="https://gowind.github.io/blog-placeholder-1.jpg"><!-- Twitter --><meta property="twitter:card" content="summary_large_image"><meta property="twitter:url" content="https://gowind.github.io/blog/promise_part2/"><meta property="twitter:title" content="Deep dive into Promises - Part II"><meta property="twitter:description" content="Static methods on Promises"><meta property="twitter:image" content="https://gowind.github.io/blog-placeholder-1.jpg"><!-- Cloudflare Web Analytics --><script defer src="https://static.cloudflareinsights.com/beacon.min.js" data-cf-beacon="{&quot;token&quot;: &quot;4de85a62d838459fafd8a042c2f1c7c2&quot;}"></script><!-- End Cloudflare Web Analytics --><style>:root{--accent: #2337ff;--accent-dark: #000d8a;--black: 15, 18, 25;--gray: 96, 115, 159;--gray-light: 229, 233, 240;--gray-dark: 34, 41, 57;--gray-gradient: rgba(var(--gray-light), 50%), #fff;--box-shadow: 0 2px 6px rgba(var(--gray), 25%), 0 8px 24px rgba(var(--gray), 33%), 0 16px 32px rgba(var(--gray), 33%)}@font-face{font-family:Atkinson;src:url(/fonts/atkinson-regular.woff) format("woff");font-weight:400;font-style:normal;font-display:swap}@font-face{font-family:Atkinson;src:url(/fonts/atkinson-bold.woff) format("woff");font-weight:700;font-style:normal;font-display:swap}@font-face{font-family:SaiyanSans;src:url(/fonts/saiyan_sans/Saiyan-Sans.ttf) format("truetype");font-weight:400;font-style:normal;font-display:swap}body{font-family:Atkinson,sans-serif;margin:0;padding:0;text-align:left;background:linear-gradient(var(--gray-gradient)) no-repeat;background-size:100% 600px;word-wrap:break-word;overflow-wrap:break-word;color:rgb(var(--gray-dark));font-size:20px;line-height:1.7}main{width:720px;max-width:calc(100% - 2em);margin:auto;padding:3em 1em}h1,h2,h3,h4,h5,h6{margin:0 0 .5rem;color:rgb(var(--black));line-height:1.2}h1{font-size:3.052em}h2{font-size:2.441em}h3{font-size:1.953em}h4{font-size:1.563em}h5{font-size:1.25em}strong,b{font-weight:700}a,a:hover{color:var(--accent)}p{margin-bottom:1em}.prose p{margin-bottom:2em}textarea{width:100%;font-size:16px}input{font-size:16px}table{width:100%}img{max-width:100%;height:auto;border-radius:8px}code{padding:2px 5px;background-color:rgb(var(--gray-light));border-radius:2px}pre{padding:1.5em;border-radius:8px}pre>code{all:unset}blockquote{border-left:4px solid var(--accent);padding:0 0 0 20px;margin:0;font-size:1.333em}hr{border:none;border-top:1px solid rgb(var(--gray-light))}@media(max-width:720px){body{font-size:18px}main{padding:1em}}.sr-only{border:0;padding:0;margin:0;position:absolute!important;height:1px;width:1px;overflow:hidden;clip:rect(1px 1px 1px 1px);clip:rect(1px,1px,1px,1px);clip-path:inset(50%);white-space:nowrap}.tag{display:inline-block;background-color:#f3f4f6;border-radius:.5rem;padding:.25rem .75rem;margin:0 .5rem .5rem 0;font-size:.875rem;font-weight:600;color:#4b5563}header[data-astro-cid-3ef6ksr2]{margin:0;padding:0 1em;background:#fff;box-shadow:0 2px 8px rgba(var(--black),5%)}h2[data-astro-cid-3ef6ksr2]{margin:0;font-size:1em}nav[data-astro-cid-3ef6ksr2]{display:flex;align-items:baseline;justify-content:space-between}.internal-links[data-astro-cid-3ef6ksr2]{font-family:SaiyanSans,sans-serif;font-spacing:1em;font-size:2rem}nav[data-astro-cid-3ef6ksr2] .internal-links[data-astro-cid-3ef6ksr2]{margin-right:10em}nav[data-astro-cid-3ef6ksr2] a[data-astro-cid-3ef6ksr2]{padding:1em .5em;color:var(--black);border-bottom:4px solid transparent;text-decoration:none}nav[data-astro-cid-3ef6ksr2] a[data-astro-cid-3ef6ksr2]:hover{color:var(--accent);color:red;animation:shake .2s;animation-iteration-count:1;text-shadow:2px 4px rgba(0,0,0,.2);font-weight:bolder}@keyframes shake{0%{transform:translate(1px,1px) rotate(0)}10%{transform:translate(-1px,-2px) rotate(-5deg)}20%{transform:translate(-3px) rotate(5deg)}30%{transform:translate(3px,2px) rotate(0)}40%{transform:translate(1px,-1px) rotate(5deg)}50%{transform:translate(-1px,2px) rotate(-5deg)}60%{transform:translate(-3px,1px) rotate(0)}70%{transform:translate(3px,1px) rotate(-5deg)}80%{transform:translate(-1px,-1px) rotate(5deg)}90%{transform:translate(1px,2px) rotate(0)}to{transform:translate(1px,-2px) rotate(-5deg)}}nav[data-astro-cid-3ef6ksr2] a[data-astro-cid-3ef6ksr2].active{text-decoration:none;border-bottom-color:red}.social-links[data-astro-cid-3ef6ksr2],.social-links[data-astro-cid-3ef6ksr2] a[data-astro-cid-3ef6ksr2]{display:flex}@media(max-width:720px){.social-links[data-astro-cid-3ef6ksr2]{display:none}}.aura-container[data-astro-cid-3ef6ksr2]{position:relative;display:inline-block;padding:60px}.aura-text[data-astro-cid-3ef6ksr2]{font-size:2.2rem;font-weight:700;font-family:SaiyanSans,sans-serif;color:red;position:relative;z-index:4;-webkit-text-stroke:1px black;letter-spacing:.1em}.aura-text[data-astro-cid-3ef6ksr2] .yellow[data-astro-cid-3ef6ksr2]{color:#ff0}.aura-text[data-astro-cid-3ef6ksr2] .organge[data-astro-cid-3ef6ksr2]{color:orange}.gif-aura[data-astro-cid-3ef6ksr2]{position:absolute;inset:0;background:url(/CFoa1-speed.gif) center/cover no-repeat;z-index:2;mix-blend-mode:screen;opacity:.8}.gif-bg-1[data-astro-cid-3ef6ksr2],.gif-bg-2[data-astro-cid-3ef6ksr2],.gif-bg-3[data-astro-cid-3ef6ksr2],.gif-bg-4[data-astro-cid-3ef6ksr2],.gif-bg-5[data-astro-cid-3ef6ksr2],.gif-bg-6[data-astro-cid-3ef6ksr2],.gif-bg-7[data-astro-cid-3ef6ksr2],.gif-bg-8[data-astro-cid-3ef6ksr2]{position:absolute;width:150px;height:150px;background:url(/CFoa1-speed.gif) center/contain no-repeat;z-index:4;mix-blend-mode:multiply;opacity:.9}.gif-bg-1[data-astro-cid-3ef6ksr2]{top:-5px;left:-5px;transform:rotate(-20deg)}.gif-bg-2[data-astro-cid-3ef6ksr2]{top:-5px;left:25%;transform:rotate(-5deg)}.gif-bg-3[data-astro-cid-3ef6ksr2]{top:-5px;left:50%;transform:rotate(5deg)}.gif-bg-4[data-astro-cid-3ef6ksr2]{top:-15px;right:-30px;transform:rotate(20deg)}.gif-bg-5[data-astro-cid-3ef6ksr2]{bottom:10px;left:-30px;transform:rotate(-160deg)}.gif-bg-6[data-astro-cid-3ef6ksr2]{bottom:10px;left:25%;transform:rotate(-160deg)}.gif-bg-7[data-astro-cid-3ef6ksr2]{bottom:10px;right:25%;transform:rotate(-160deg)}.gif-bg-8[data-astro-cid-3ef6ksr2]{bottom:10px;right:-30px;transform:rotate(160deg)}
a[data-astro-cid-eimmu3lg]{display:inline-block;text-decoration:none}a[data-astro-cid-eimmu3lg].active{font-weight:bolder;text-decoration:underline}
.scrollrectangle[data-astro-cid-bvzihdzo]{position:fixed;right:20px;width:20px;height:100px;background-color:#2c65d7;border-radius:10%;transition:top .3s ease-out;transform-origin:center center;animation:squeeze 1s infinite}@keyframes squeeze{0%{transform:scaleY(1)}50%{transform:scaleY(1.5)}to{transform:scaleY(1)}}main[data-astro-cid-bvzihdzo]{width:calc(100% - 2em);max-width:100%;margin:0}.hero-image[data-astro-cid-bvzihdzo]{width:100%}.hero-image[data-astro-cid-bvzihdzo] img[data-astro-cid-bvzihdzo]{display:block;margin:0 auto;border-radius:12px;box-shadow:var(--box-shadow)}.prose[data-astro-cid-bvzihdzo]{width:720px;max-width:calc(100% - 2em);margin:auto;padding:1em;color:rgb(var(--gray-dark))}.title[data-astro-cid-bvzihdzo]{margin-bottom:1em;padding:1em 0;text-align:center;line-height:1}.title[data-astro-cid-bvzihdzo] h1[data-astro-cid-bvzihdzo]{margin:0 0 .5em}.date[data-astro-cid-bvzihdzo]{margin-bottom:.5em;color:rgb(var(--gray))}.last-updated-on[data-astro-cid-bvzihdzo]{font-style:italic}
</style></head> <body data-astro-cid-bvzihdzo> <header data-astro-cid-3ef6ksr2> <nav data-astro-cid-3ef6ksr2> <div class="aura-container" data-astro-cid-3ef6ksr2> <div class="gif-bg-1" data-astro-cid-3ef6ksr2></div> <div class="gif-bg-2" data-astro-cid-3ef6ksr2></div> <div class="gif-bg-3" data-astro-cid-3ef6ksr2></div> <h2 class="aura-text" data-astro-cid-3ef6ksr2> <a href="/" data-astro-cid-3ef6ksr2> <span class="yellow" data-astro-cid-3ef6ksr2>Govind's</span> <img src="/dragonball.jpg" width="30px" height="30px" data-astro-cid-3ef6ksr2> <span data-astro-cid-3ef6ksr2>Blog</span> </a></h2> </div> <div class="internal-links" data-astro-cid-3ef6ksr2> <a href="/" data-astro-cid-3ef6ksr2="true" data-astro-cid-eimmu3lg> Home </a>  <a href="/blog" class="active" data-astro-cid-3ef6ksr2="true" data-astro-cid-eimmu3lg> Blog </a>  <a href="/ideas" data-astro-cid-3ef6ksr2="true" data-astro-cid-eimmu3lg> Steal My Ideas </a>  <a href="/editor" data-astro-cid-3ef6ksr2="true" data-astro-cid-eimmu3lg> Image Editor </a>  </div> <div class="social-links" data-astro-cid-3ef6ksr2> <a href="https://x.com/DeepknowledgeU" target="_blank" data-astro-cid-3ef6ksr2> <span class="sr-only" data-astro-cid-3ef6ksr2>Follow Astro on X</span> <svg viewBox="0 0 16 16" aria-hidden="true" width="32" height="32" astro-icon="social/twitter" data-astro-cid-3ef6ksr2><path fill="currentColor" d="M5.026 15c6.038 0 9.341-5.003 9.341-9.334 0-.14 0-.282-.006-.422A6.685 6.685 0 0 0 16 3.542a6.658 6.658 0 0 1-1.889.518 3.301 3.301 0 0 0 1.447-1.817 6.533 6.533 0 0 1-2.087.793A3.286 3.286 0 0 0 7.875 6.03a9.325 9.325 0 0 1-6.767-3.429 3.289 3.289 0 0 0 1.018 4.382A3.323 3.323 0 0 1 .64 6.575v.045a3.288 3.288 0 0 0 2.632 3.218 3.203 3.203 0 0 1-.865.115 3.23 3.23 0 0 1-.614-.057 3.283 3.283 0 0 0 3.067 2.277A6.588 6.588 0 0 1 .78 13.58a6.32 6.32 0 0 1-.78-.045A9.344 9.344 0 0 0 5.026 15z" data-astro-cid-3ef6ksr2></path></svg> </a> <a href="https://github.com/Gowind" target="_blank" data-astro-cid-3ef6ksr2> <span class="sr-only" data-astro-cid-3ef6ksr2>My Github</span> <svg viewBox="0 0 16 16" aria-hidden="true" width="32" height="32" astro-icon="social/github" data-astro-cid-3ef6ksr2><path fill="currentColor" d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.012 8.012 0 0 0 16 8c0-4.42-3.58-8-8-8z" data-astro-cid-3ef6ksr2></path></svg> </a> </div> </nav> </header>  <main data-astro-cid-bvzihdzo> <article data-astro-cid-bvzihdzo> <div class="scrollrectangle" data-astro-cid-bvzihdzo></div> <script type="module">const o=document.querySelector(".ball"),c=document.querySelector("header"),r=document.documentElement.scrollHeight-window.innerHeight,t=c?.offsetHeight;o.style.top=`${t+100}px`;window.addEventListener("scroll",()=>{const n=window.scrollY/r,l=window.innerHeight-100;let e=n*l;e=e>=t+100?e:t+100,o.style.top=`${e}px`});</script> <div class="hero-image" data-astro-cid-bvzihdzo>  </div> <div class="prose" data-astro-cid-bvzihdzo> <div class="title" data-astro-cid-bvzihdzo> <div class="date" data-astro-cid-bvzihdzo> <time datetime="2025-11-21T00:00:00.000Z"> Nov 21, 2025 </time>  </div> <h1 data-astro-cid-bvzihdzo>Deep dive into Promises - Part II</h1> <hr data-astro-cid-bvzihdzo> </div>  <p>In the previous post, we learnt the following things about the implementation of a Promise</p>
<ol>
<li>A Promise is a JSObject that takes an <code>Executor</code> fn object as argument.</li>
<li>The <code>Executor</code> fn object takes 2 fns : <code>resolve</code> and <code>reject</code> of class <code>JS_CLASS_PROMISE_RESOLVE_FUNCTION</code> and <code>JS_CLASS_PROMISE_REJECT_FUNCTION</code> respectively as arguments.</li>
<li>The resolve and reject fns have a payload of type <code>JSPromiseFunctionData</code> that have pointers to the Promise so that the fns can resolve/reject the promise when called.</li>
<li>When a promise is fulfilled or rejected, all the callbacks associated with promise are enqueued as <code>microtasks</code>.</li>
<li>When the execution context is empty and there are pending callbacks on promises, the runtime dequeues the callbacks from the microtask queue and executes the callbacks.</li>
</ol>
<p>The Promise API provides static methods, such as <code>resolve</code> and <code>reject</code> that immediately returns a fulfilled or a rejected promise. These static methods do not take an <code>executor</code> fn as argument, but a value (or <code>thenable</code> object that we will ignore for now, for more details, check out the <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Promise/resolve">MDN docs</a>) and returns a Promise that resolves to the value, thus essentially being a shorthand for <code>new Promise((resolve) => resolve(value)).</code></p>
<p>As we saw in the last post, the C function that implements the constructs the  Promise object, expects an <code>executor</code> to be passed as the first argument:</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="c"><code><span class="line"><span style="color:#F97583">static</span><span style="color:#E1E4E8"> JSValue </span><span style="color:#B392F0">js_promise_constructor</span><span style="color:#E1E4E8">(JSContext </span><span style="color:#F97583">*</span><span style="color:#FFAB70">ctx</span><span style="color:#E1E4E8">, JSValueConst </span><span style="color:#FFAB70">new_target</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#F97583">                                      int</span><span style="color:#FFAB70"> argc</span><span style="color:#E1E4E8">, JSValueConst </span><span style="color:#F97583">*</span><span style="color:#FFAB70">argv</span><span style="color:#E1E4E8">)</span></span>
<span class="line"><span style="color:#E1E4E8">{</span></span>
<span class="line"><span style="color:#E1E4E8">    JSValueConst executor;</span></span>
<span class="line"><span style="color:#E1E4E8">    JSValue obj;</span></span>
<span class="line"><span style="color:#E1E4E8">    JSPromiseData </span><span style="color:#F97583">*</span><span style="color:#E1E4E8">s;</span></span>
<span class="line"><span style="color:#E1E4E8">    JSValue </span><span style="color:#FFAB70">args</span><span style="color:#E1E4E8">[</span><span style="color:#79B8FF">2</span><span style="color:#E1E4E8">], ret;</span></span>
<span class="line"><span style="color:#F97583">    int</span><span style="color:#E1E4E8"> i;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8">    executor </span><span style="color:#F97583">=</span><span style="color:#FFAB70"> argv</span><span style="color:#E1E4E8">[</span><span style="color:#79B8FF">0</span><span style="color:#E1E4E8">];</span></span>
<span class="line"><span style="color:#F97583">    if</span><span style="color:#E1E4E8"> (</span><span style="color:#B392F0">check_function</span><span style="color:#E1E4E8">(ctx, executor))</span></span>
<span class="line"><span style="color:#F97583">        return</span><span style="color:#E1E4E8"> JS_EXCEPTION;</span></span></code></pre>
<p>However, the static Promise.<code>resolve</code>  and <code>reject</code> methods take only a value as argument, so how does this work ?</p>
<p>Turns out, there are separate C fns in the interpreter’s code that implement the static <code>resolve</code> and <code>reject</code> methods. These fns create a <code>dummy</code> or a sort of proxy Executor fn that when called with <code>resolve, reject</code> args, just captures the reference to the Promise from the <code>resolve</code> and <code>reject</code> args.
The captured reference to the Promise is then used by the C fns to resolve the Promise.
Lets see how that works.</p>
<p>In quickjs both <code>Promise.resolve</code> and <code>Promise.reject</code> static methods are handled by the same C function: <code>js_promise_resolve</code>. A fulfilled vs rejected Promise is distinguised using the the 4th <code>magic</code> argument</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="c"><code><span class="line"><span style="color:#F97583">static</span><span style="color:#F97583"> const</span><span style="color:#E1E4E8"> JSCFunctionListEntry js_promise_funcs</span><span style="color:#F97583">[]</span><span style="color:#F97583"> =</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#B392F0">    JS_CFUNC_MAGIC_DEF</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">"resolve"</span><span style="color:#E1E4E8">, </span><span style="color:#79B8FF">1</span><span style="color:#E1E4E8">, js_promise_resolve, </span><span style="color:#79B8FF">0</span><span style="color:#E1E4E8"> ),</span></span>
<span class="line"><span style="color:#B392F0">    JS_CFUNC_MAGIC_DEF</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">"reject"</span><span style="color:#E1E4E8">, </span><span style="color:#79B8FF">1</span><span style="color:#E1E4E8">, js_promise_resolve, </span><span style="color:#79B8FF">1</span><span style="color:#E1E4E8"> ),</span><span style="color:#6A737D"> // magic == 1</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">static</span><span style="color:#E1E4E8"> JSValue </span><span style="color:#B392F0">js_promise_resolve</span><span style="color:#E1E4E8">(JSContext </span><span style="color:#F97583">*</span><span style="color:#E1E4E8">ctx, JSValueConst this_val,</span></span>
<span class="line"><span style="color:#F97583">                                  int</span><span style="color:#E1E4E8"> argc, JSValueConst </span><span style="color:#F97583">*</span><span style="color:#E1E4E8">argv, </span><span style="color:#F97583">int</span><span style="color:#E1E4E8"> magic)</span></span>
<span class="line"><span style="color:#E1E4E8">{</span></span>
<span class="line"><span style="color:#E1E4E8">    JSValue result_promise, </span><span style="color:#FFAB70">resolving_funcs</span><span style="color:#E1E4E8">[</span><span style="color:#79B8FF">2</span><span style="color:#E1E4E8">], ret;</span></span>
<span class="line"><span style="color:#E1E4E8">    BOOL is_reject </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> magic;</span></span>
<span class="line"><span style="color:#6A737D">    // if passsed value is another Promise simply return a reference to it</span></span>
<span class="line"><span style="color:#E1E4E8">    </span></span>
<span class="line"><span style="color:#E1E4E8">    result_promise </span><span style="color:#F97583">=</span><span style="color:#B392F0"> js_new_promise_capability</span><span style="color:#E1E4E8">(ctx, resolving_funcs, this_val);</span></span>
<span class="line"><span style="color:#E1E4E8">    ...</span></span>
<span class="line"><span style="color:#E1E4E8">    ret </span><span style="color:#F97583">=</span><span style="color:#B392F0"> JS_Call</span><span style="color:#E1E4E8">(ctx, </span><span style="color:#FFAB70">resolving_funcs</span><span style="color:#E1E4E8">[is_reject], JS_UNDEFINED, </span><span style="color:#79B8FF">1</span><span style="color:#E1E4E8">, argv);</span></span>
<span class="line"><span style="color:#E1E4E8">    ...</span></span>
<span class="line"><span style="color:#F97583">    return</span><span style="color:#E1E4E8"> result_promise;</span></span></code></pre>
<p><code>js_new_promise_capability</code> is the fn that creates a constructs a Promise with a dummy executor. It takes as arguments 2 resolving fns that capture a reference to the <code>result_promise</code>.
When the correct <code>resolving_funcs</code> is called with the value to be resolved, it sets the <code>result_promise</code>’s <code>JSPromiseData->promise_result</code> to the <code>argv</code> JSValue that is passed, thus resolving the Promise and returning it.</p>
<p>Diving a bit into <code>js_new_promise_capability</code> fn we see how the <code>dummy</code> executor is created and the reference to the Promise’s resolving fns are captured and returned</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="c"><code><span class="line"><span style="color:#F97583">static</span><span style="color:#E1E4E8"> JSValue </span><span style="color:#B392F0">js_new_promise_capability</span><span style="color:#E1E4E8">(JSContext </span><span style="color:#F97583">*</span><span style="color:#FFAB70">ctx</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#E1E4E8">                                         JSValue </span><span style="color:#F97583">*</span><span style="color:#FFAB70">resolving_funcs</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#E1E4E8">                                         JSValueConst </span><span style="color:#FFAB70">ctor</span><span style="color:#E1E4E8">)</span></span>
<span class="line"><span style="color:#E1E4E8">{</span></span>
<span class="line"><span style="color:#E1E4E8">    JSValue executor, result_promise;</span></span>
<span class="line"><span style="color:#E1E4E8">    JSCFunctionDataRecord </span><span style="color:#F97583">*</span><span style="color:#E1E4E8">s;</span></span>
<span class="line"><span style="color:#F97583">    int</span><span style="color:#E1E4E8"> i;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8">    executor </span><span style="color:#F97583">=</span><span style="color:#B392F0"> js_promise_executor_new</span><span style="color:#E1E4E8">(ctx);</span></span>
<span class="line"><span style="color:#E1E4E8">    result_promise </span><span style="color:#F97583">=</span><span style="color:#B392F0"> js_promise_constructor</span><span style="color:#E1E4E8">(ctx, ctor, </span><span style="color:#79B8FF">1</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#E1E4E8">                                                (JSValueConst </span><span style="color:#F97583">*</span><span style="color:#E1E4E8">)</span><span style="color:#F97583">&#x26;</span><span style="color:#E1E4E8">executor);</span></span>
<span class="line"><span style="color:#E1E4E8">    ...</span></span>
<span class="line"><span style="color:#E1E4E8">    s </span><span style="color:#F97583">=</span><span style="color:#B392F0"> JS_GetOpaque</span><span style="color:#E1E4E8">(executor, JS_CLASS_C_FUNCTION_DATA);</span></span>
<span class="line"><span style="color:#E1E4E8">    </span></span>
<span class="line"><span style="color:#F97583">    for</span><span style="color:#E1E4E8">(i </span><span style="color:#F97583">=</span><span style="color:#79B8FF"> 0</span><span style="color:#E1E4E8">; i </span><span style="color:#F97583">&#x3C;</span><span style="color:#79B8FF"> 2</span><span style="color:#E1E4E8">; i</span><span style="color:#F97583">++</span><span style="color:#E1E4E8">)</span></span>
<span class="line"><span style="color:#FFAB70">        resolving_funcs</span><span style="color:#E1E4E8">[i] </span><span style="color:#F97583">=</span><span style="color:#B392F0"> JS_DupValue</span><span style="color:#E1E4E8">(ctx, s->data[i]);</span></span>
<span class="line"><span style="color:#B392F0">    JS_FreeValue</span><span style="color:#E1E4E8">(ctx, executor);</span></span>
<span class="line"><span style="color:#F97583">    return</span><span style="color:#E1E4E8"> result_promise;</span></span></code></pre>
<p>The dummy executor is a <code>JSObject</code> that has a <code>class_id</code> of <code>JS_CLASS_C_FUNCTION_DATA</code>. JSObjects of this class_id have a variable length <code>data</code> payload that can be used to store references to other objects , which is our case are the Promise’s resolving functions</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="c"><code><span class="line"><span style="color:#E1E4E8">JSCFunctionDataRecord {</span></span>
<span class="line"><span style="color:#E1E4E8">    JSCFunctionData </span><span style="color:#F97583">*</span><span style="color:#E1E4E8">func;</span></span>
<span class="line"><span style="color:#F97583">    uint8_t</span><span style="color:#E1E4E8"> length;</span></span>
<span class="line"><span style="color:#F97583">    uint8_t</span><span style="color:#E1E4E8"> data_len;</span></span>
<span class="line"><span style="color:#F97583">    uint16_t</span><span style="color:#E1E4E8"> magic;</span></span>
<span class="line"><span style="color:#E1E4E8">    JSValue </span><span style="color:#FFAB70">data</span><span style="color:#E1E4E8">[</span><span style="color:#79B8FF">0</span><span style="color:#E1E4E8">];</span></span>
<span class="line"><span style="color:#E1E4E8">} JSCFunctionDataRecord;</span></span></code></pre>
<p>The dummy executor captures the <code>resolve</code> and <code>reject</code> into the <code>data</code> field</p>
<p>This is how a JSObject of class_id <code>JS_CLASS_C_FUNCTION_DATA</code> is created:</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="c"><code><span class="line"><span style="color:#E1E4E8">JSValue </span><span style="color:#B392F0">JS_NewCFunctionData</span><span style="color:#E1E4E8">(JSContext </span><span style="color:#F97583">*</span><span style="color:#FFAB70">ctx</span><span style="color:#E1E4E8">, JSCFunctionData </span><span style="color:#F97583">*</span><span style="color:#FFAB70">func</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#F97583">                            int</span><span style="color:#FFAB70"> length</span><span style="color:#E1E4E8">, </span><span style="color:#F97583">int</span><span style="color:#FFAB70"> magic</span><span style="color:#E1E4E8">, </span><span style="color:#F97583">int</span><span style="color:#FFAB70"> data_len</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#E1E4E8">                            JSValueConst </span><span style="color:#F97583">*</span><span style="color:#FFAB70">data</span><span style="color:#E1E4E8">)</span></span>
<span class="line"><span style="color:#E1E4E8">{</span></span>
<span class="line"><span style="color:#E1E4E8">    JSCFunctionDataRecord </span><span style="color:#F97583">*</span><span style="color:#E1E4E8">s;</span></span>
<span class="line"><span style="color:#E1E4E8">    JSValue func_obj;</span></span>
<span class="line"><span style="color:#F97583">    int</span><span style="color:#E1E4E8"> i;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8">    func_obj </span><span style="color:#F97583">=</span><span style="color:#B392F0"> JS_NewObjectProtoClass</span><span style="color:#E1E4E8">(ctx, ctx->function_proto,</span></span>
<span class="line"><span style="color:#E1E4E8">                                      JS_CLASS_C_FUNCTION_DATA);</span></span>
<span class="line"><span style="color:#E1E4E8">    </span></span>
<span class="line"><span style="color:#6A737D">    // we create space for capturing the resolving fns</span></span>
<span class="line"><span style="color:#E1E4E8">    s </span><span style="color:#F97583">=</span><span style="color:#B392F0"> js_malloc</span><span style="color:#E1E4E8">(ctx, </span><span style="color:#F97583">sizeof</span><span style="color:#E1E4E8">(</span><span style="color:#F97583">*</span><span style="color:#E1E4E8">s) </span><span style="color:#F97583">+</span><span style="color:#E1E4E8"> data_len </span><span style="color:#F97583">*</span><span style="color:#F97583"> sizeof</span><span style="color:#E1E4E8">(JSValue));</span></span>
<span class="line"><span style="color:#E1E4E8">    </span></span>
<span class="line"><span style="color:#E1E4E8">    s->func </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> func;</span></span>
<span class="line"><span style="color:#E1E4E8">    s->length </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> length;</span></span>
<span class="line"><span style="color:#E1E4E8">    s->data_len </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> data_len;</span></span>
<span class="line"><span style="color:#E1E4E8">    s->magic </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> magic;</span></span>
<span class="line"><span style="color:#F97583">    for</span><span style="color:#E1E4E8">(i </span><span style="color:#F97583">=</span><span style="color:#79B8FF"> 0</span><span style="color:#E1E4E8">; i </span><span style="color:#F97583">&#x3C;</span><span style="color:#E1E4E8"> data_len; i</span><span style="color:#F97583">++</span><span style="color:#E1E4E8">)</span></span>
<span class="line"><span style="color:#E1E4E8">        s->data[i] </span><span style="color:#F97583">=</span><span style="color:#B392F0"> JS_DupValue</span><span style="color:#E1E4E8">(ctx, </span><span style="color:#FFAB70">data</span><span style="color:#E1E4E8">[i]);</span></span>
<span class="line"><span style="color:#B392F0">    JS_SetOpaque</span><span style="color:#E1E4E8">(func_obj, s);</span></span>
<span class="line"><span style="color:#B392F0">    js_function_set_properties</span><span style="color:#E1E4E8">(ctx, func_obj,</span></span>
<span class="line"><span style="color:#E1E4E8">                               JS_ATOM_empty_string, length);</span></span>
<span class="line"><span style="color:#F97583">    return</span><span style="color:#E1E4E8"> func_obj;</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span>
<span class="line"><span style="color:#6A737D">// Fn that creates dummy executor</span></span>
<span class="line"><span style="color:#6A737D">// js_promise_executor is the executor fn that is </span></span>
<span class="line"><span style="color:#6A737D">// passed to the Promise constructor</span></span>
<span class="line"><span style="color:#F97583">static</span><span style="color:#E1E4E8"> JSValue </span><span style="color:#B392F0">js_promise_executor_new</span><span style="color:#E1E4E8">(JSContext </span><span style="color:#F97583">*</span><span style="color:#FFAB70">ctx</span><span style="color:#E1E4E8">)</span></span>
<span class="line"><span style="color:#E1E4E8">{</span></span>
<span class="line"><span style="color:#E1E4E8">    JSValueConst </span><span style="color:#FFAB70">func_data</span><span style="color:#E1E4E8">[</span><span style="color:#79B8FF">2</span><span style="color:#E1E4E8">];</span></span>
<span class="line"></span>
<span class="line"><span style="color:#FFAB70">    func_data</span><span style="color:#E1E4E8">[</span><span style="color:#79B8FF">0</span><span style="color:#E1E4E8">] </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> JS_UNDEFINED;</span></span>
<span class="line"><span style="color:#FFAB70">    func_data</span><span style="color:#E1E4E8">[</span><span style="color:#79B8FF">1</span><span style="color:#E1E4E8">] </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> JS_UNDEFINED;</span></span>
<span class="line"><span style="color:#F97583">    return</span><span style="color:#B392F0"> JS_NewCFunctionData</span><span style="color:#E1E4E8">(ctx, js_promise_executor, </span><span style="color:#79B8FF">2</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#79B8FF">                               0</span><span style="color:#E1E4E8">, </span><span style="color:#79B8FF">2</span><span style="color:#E1E4E8">, func_data);</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span>
<span class="line"><span style="color:#6A737D">// the executor that is called by the Promise constructor</span></span>
<span class="line"><span style="color:#6A737D">// func_data is the data variable length array in the </span></span>
<span class="line"><span style="color:#6A737D">// JSCFunctionDataRecord payload returned by js_promise_executor_new</span></span>
<span class="line"><span style="color:#6A737D">// and argv are the Promise's resolve and reject fns</span></span>
<span class="line"><span style="color:#6A737D">// we copy the resolve and reject fns into data[0] and data[1]</span></span>
<span class="line"><span style="color:#F97583">static</span><span style="color:#E1E4E8"> JSValue </span><span style="color:#B392F0">js_promise_executor</span><span style="color:#E1E4E8">(JSContext </span><span style="color:#F97583">*</span><span style="color:#FFAB70">ctx</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#E1E4E8">                                   JSValueConst </span><span style="color:#FFAB70">this_val</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#F97583">                                   int</span><span style="color:#FFAB70"> argc</span><span style="color:#E1E4E8">, JSValueConst </span><span style="color:#F97583">*</span><span style="color:#FFAB70">argv</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#F97583">                                   int</span><span style="color:#FFAB70"> magic</span><span style="color:#E1E4E8">, JSValue </span><span style="color:#F97583">*</span><span style="color:#FFAB70">func_data</span><span style="color:#E1E4E8">)</span></span>
<span class="line"><span style="color:#E1E4E8">{</span></span>
<span class="line"><span style="color:#F97583">    int</span><span style="color:#E1E4E8"> i;</span></span>
<span class="line"><span style="color:#F97583">    for</span><span style="color:#E1E4E8">(i </span><span style="color:#F97583">=</span><span style="color:#79B8FF"> 0</span><span style="color:#E1E4E8">; i </span><span style="color:#F97583">&#x3C;</span><span style="color:#79B8FF"> 2</span><span style="color:#E1E4E8">; i</span><span style="color:#F97583">++</span><span style="color:#E1E4E8">) {</span></span>
<span class="line"><span style="color:#F97583">        if</span><span style="color:#E1E4E8"> (</span><span style="color:#F97583">!</span><span style="color:#B392F0">JS_IsUndefined</span><span style="color:#E1E4E8">(</span><span style="color:#FFAB70">func_data</span><span style="color:#E1E4E8">[i]))</span></span>
<span class="line"><span style="color:#F97583">            return</span><span style="color:#B392F0"> JS_ThrowTypeError</span><span style="color:#E1E4E8">(ctx, </span><span style="color:#9ECBFF">"resolving function already set"</span><span style="color:#E1E4E8">);</span></span>
<span class="line"><span style="color:#FFAB70">        func_data</span><span style="color:#E1E4E8">[i] </span><span style="color:#F97583">=</span><span style="color:#B392F0"> JS_DupValue</span><span style="color:#E1E4E8">(ctx, </span><span style="color:#FFAB70">argv</span><span style="color:#E1E4E8">[i]);</span></span>
<span class="line"><span style="color:#E1E4E8">    }</span></span>
<span class="line"><span style="color:#F97583">    return</span><span style="color:#E1E4E8"> JS_UNDEFINED;</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span></code></pre>
<p>Congrats on making it so far, the last section can be quite confusing to keep track of in your head, so let me try to summarize what happened.</p>
<ol>
<li>Static methods like <code>Promise.resolve</code> and <code>Promise.reject</code> take a value and not an executor fn as argument. They return a Promise that resolves to the value (or rejects with the value)</li>
<li>These JS Promise static methods are implemented in the interpreter via the <code>js_promise_resolve</code> C function.</li>
<li>In <code>js_promise_resolve</code>, a <code>dummy</code> executor of class <code>JS_CLASS_C_FUNCTION_DATA</code> is created. This executor class has a <code>data</code> slot in its definition that can be used to store references to JSValues(s).</li>
<li>The <code>dummy</code> executor  is passed as the executor argument when creating a promise and this <code>dummy</code> executor captures the resolve and reject fns passed to it into its <code>data</code> slots.</li>
<li><code>js_promise_resolve</code> extracts the resolve and the reject fns from the <code>data</code> slot of the dummy executor and then calls them with the value passed to <code>resolve/reject</code> thus fulfilling the promise and returns the promise.</li>
</ol>
<p>The last function we will see in this post is the static method <code>Promise.race</code>. Knowing how <code>resolve</code>, <code>reject</code> and Promise handlers are implemented will help us understand how <code>race</code> works, thus laying the foundation for understanding why our original “bug” happened.</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="c"><code><span class="line"><span style="color:#F97583">static</span><span style="color:#E1E4E8"> JSValue </span><span style="color:#B392F0">js_promise_race</span><span style="color:#E1E4E8">(JSContext </span><span style="color:#F97583">*</span><span style="color:#FFAB70">ctx</span><span style="color:#E1E4E8">, JSValueConst </span><span style="color:#FFAB70">this_val</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#F97583">                               int</span><span style="color:#FFAB70"> argc</span><span style="color:#E1E4E8">, JSValueConst </span><span style="color:#F97583">*</span><span style="color:#FFAB70">argv</span><span style="color:#E1E4E8">)</span></span>
<span class="line"><span style="color:#E1E4E8">{</span></span>
<span class="line"><span style="color:#E1E4E8">    JSValue result_promise, </span><span style="color:#FFAB70">resolving_funcs</span><span style="color:#E1E4E8">[</span><span style="color:#79B8FF">2</span><span style="color:#E1E4E8">], item, next_promise, ret;</span></span>
<span class="line"><span style="color:#E1E4E8">    JSValue next_method </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> JS_UNDEFINED, iter </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> JS_UNDEFINED;</span></span>
<span class="line"><span style="color:#E1E4E8">    JSValue promise_resolve </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> JS_UNDEFINED;</span></span>
<span class="line"><span style="color:#E1E4E8">    BOOL done;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">    // create a promise and extract its resolve and reject </span></span>
<span class="line"><span style="color:#6A737D">    // similar to the mechanism used for `resolve` and `reject`</span></span>
<span class="line"><span style="color:#E1E4E8">    result_promise </span><span style="color:#F97583">=</span><span style="color:#B392F0"> js_new_promise_capability</span><span style="color:#E1E4E8">(ctx, resolving_funcs, this_val);</span></span>
<span class="line"><span style="color:#E1E4E8">    promise_resolve </span><span style="color:#F97583">=</span><span style="color:#B392F0"> JS_GetProperty</span><span style="color:#E1E4E8">(ctx, this_val, JS_ATOM_resolve);</span></span>
<span class="line"><span style="color:#E1E4E8">    iter </span><span style="color:#F97583">=</span><span style="color:#B392F0"> JS_GetIterator</span><span style="color:#E1E4E8">(ctx, </span><span style="color:#FFAB70">argv</span><span style="color:#E1E4E8">[</span><span style="color:#79B8FF">0</span><span style="color:#E1E4E8">], </span><span style="color:#79B8FF">FALSE</span><span style="color:#E1E4E8">);</span></span>
<span class="line"><span style="color:#E1E4E8">    next_method </span><span style="color:#F97583">=</span><span style="color:#B392F0"> JS_GetProperty</span><span style="color:#E1E4E8">(ctx, iter, JS_ATOM_next);</span></span>
<span class="line"><span style="color:#F97583">    for</span><span style="color:#E1E4E8">(;;) {</span></span>
<span class="line"><span style="color:#6A737D">            /* XXX: conformance: should close the iterator if error on 'done'</span></span>
<span class="line"><span style="color:#6A737D">               access, but not on 'value' access */</span></span>
<span class="line"><span style="color:#E1E4E8">            item </span><span style="color:#F97583">=</span><span style="color:#B392F0"> JS_IteratorNext</span><span style="color:#E1E4E8">(ctx, iter, next_method, </span><span style="color:#79B8FF">0</span><span style="color:#E1E4E8">, </span><span style="color:#79B8FF">NULL</span><span style="color:#E1E4E8">, </span><span style="color:#F97583">&#x26;</span><span style="color:#E1E4E8">done);</span></span>
<span class="line"><span style="color:#F97583">            if</span><span style="color:#E1E4E8"> (done)</span></span>
<span class="line"><span style="color:#F97583">                break</span><span style="color:#E1E4E8">;</span></span>
<span class="line"><span style="color:#E1E4E8">            next_promise </span><span style="color:#F97583">=</span><span style="color:#B392F0"> JS_Call</span><span style="color:#E1E4E8">(ctx, promise_resolve,</span></span>
<span class="line"><span style="color:#E1E4E8">                                   this_val, </span><span style="color:#79B8FF">1</span><span style="color:#E1E4E8">, (JSValueConst </span><span style="color:#F97583">*</span><span style="color:#E1E4E8">)</span><span style="color:#F97583">&#x26;</span><span style="color:#E1E4E8">item);</span></span>
<span class="line"><span style="color:#E1E4E8">            </span></span>
<span class="line"><span style="color:#E1E4E8">            ret </span><span style="color:#F97583">=</span><span style="color:#B392F0"> JS_InvokeFree</span><span style="color:#E1E4E8">(ctx, next_promise, JS_ATOM_then, </span><span style="color:#79B8FF">2</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#E1E4E8">                                (JSValueConst </span><span style="color:#F97583">*</span><span style="color:#E1E4E8">)resolving_funcs);</span></span>
<span class="line"><span style="color:#F97583">            if</span><span style="color:#E1E4E8"> (</span><span style="color:#B392F0">check_exception_free</span><span style="color:#E1E4E8">(ctx, ret))</span></span>
<span class="line"><span style="color:#F97583">                goto</span><span style="color:#E1E4E8"> fail_reject1;</span></span>
<span class="line"><span style="color:#E1E4E8">        }</span></span>
<span class="line"><span style="color:#F97583">  return</span><span style="color:#E1E4E8"> result_promise;</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span></code></pre>
<p><code>race</code> iterates through the array passed as an argument. In each iterator, it first turns the array item into a Promise if it is not one (via <code>next_promise = JS_Call(ctx, promise_resolve, this_val, 1, (JSValueConst *)&#x26;item);)</code>) and then calls <code>js_promise_then</code> on <code>next_promise</code>. As we saw from our previous post, this is nothing but calling the <code>.then</code> handler on a promise, which if the promise is already fulfilled , schedules a microtask. What is the scheduled microtask in the case of <code>race</code> ? It simply calls the resolving function of the Promise (<code>result_promise</code>) that is returned by <code>race</code></p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="c"><code><span class="line"><span style="color:#6A737D">    //resolving_funcs point to result_promise so that when they are called they resolve result_promise</span></span>
<span class="line"><span style="color:#6A737D">    // if it isn't already resolved</span></span>
<span class="line"><span style="color:#E1E4E8">    result_promise </span><span style="color:#F97583">=</span><span style="color:#B392F0"> js_new_promise_capability</span><span style="color:#E1E4E8">(ctx, resolving_funcs, this_val);</span></span>
<span class="line"><span style="color:#E1E4E8">    ...</span></span>
<span class="line"><span style="color:#F97583">    for</span><span style="color:#E1E4E8">(;;) {</span></span>
<span class="line"><span style="color:#E1E4E8">            ...</span></span>
<span class="line"><span style="color:#6A737D">            // if next_promise is already fulfilled, a microtasks is enqueued that calls the appropriate resolving_funcs</span></span>
<span class="line"><span style="color:#6A737D">            // if not, the resolving_funcs are changed to the existing promise_reaction handles on `next_promise`</span></span>
<span class="line"><span style="color:#E1E4E8">            ret </span><span style="color:#F97583">=</span><span style="color:#B392F0"> JS_InvokeFree</span><span style="color:#E1E4E8">(ctx, next_promise, JS_ATOM_then, </span><span style="color:#79B8FF">2</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#E1E4E8">                                (JSValueConst </span><span style="color:#F97583">*</span><span style="color:#E1E4E8">)resolving_funcs);</span></span>
<span class="line"><span style="color:#F97583">            if</span><span style="color:#E1E4E8"> (</span><span style="color:#B392F0">check_exception_free</span><span style="color:#E1E4E8">(ctx, ret))</span></span></code></pre>
<p>If none of the promises in the race array argument <code>.race([a, b, ...])</code> are fulfilled during the time of the call, the resolving funcs are simply chained to the <code>promise_reaction</code> handlers of each of the promise in the array and the promise that fulfills first calls the resolving func, thus setting the result of our <code>result_promise</code> to the value of the first promise in the arguments that get fulfilled.</p>
<p>To recap what we have learnt so far in this edition of Promises:</p>
<ol>
<li>static methods like <code>Promise.reject</code> and <code>Promise.resolve</code> create a <code>dummy</code> executor of type <code>JSCFunctionData</code> that capture a refernce to a Promise and resolve it with the value passed to them as arguments</li>
<li><code>Promise.race</code> creates a <code>return_promise</code>  and iterates through an array of promises passed as argument. It builds on top of the <code>.then</code> handler of a Promise that when called, enqueues a microtask if the promise is already resolved or sets up the promises’ reaction handlers to call a handler func. To each of the promise in the argument array, it calls the <code>then</code> handler of that promise with the resolving funcs of <code>result_promise</code> as args, thus chaining the fulfillment of <code>result_promise</code> to the first promise that resolves.</li>
</ol>
<p>In part 3, the final chapter, we will take a look at why initial bug occured because we annotated our function as <code>async</code> and how returning a promise directly from a non-async function fixed the problem.</p>  </div> </article> </main> </body></html>