<!DOCTYPE html><html lang="en" data-astro-cid-bvzihdzo> <head><!-- Global Metadata --><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1"><link rel="icon" type="image/svg+xml" href="/favicon.svg"><meta name="generator" content="Astro v5.1.1"><!-- Font preloads --><link rel="preload" href="/fonts/atkinson-regular.woff" as="font" type="font/woff" crossorigin><link rel="preload" href="/fonts/atkinson-bold.woff" as="font" type="font/woff" crossorigin><!-- Canonical URL --><link rel="canonical" href="https://gowind.github.io/blog/why_is_my_event_loop_still_alive/"><!-- Primary Meta Tags --><title>Why is my event loop still running?</title><meta name="title" content="Why is my event loop still running?"><meta name="description" content="Investigations into why my node process stays alive after tests finish running"><!-- Open Graph / Facebook --><meta property="og:type" content="website"><meta property="og:url" content="https://gowind.github.io/blog/why_is_my_event_loop_still_alive/"><meta property="og:title" content="Why is my event loop still running?"><meta property="og:description" content="Investigations into why my node process stays alive after tests finish running"><meta property="og:image" content="https://gowind.github.io/blog-placeholder-1.jpg"><!-- Twitter --><meta property="twitter:card" content="summary_large_image"><meta property="twitter:url" content="https://gowind.github.io/blog/why_is_my_event_loop_still_alive/"><meta property="twitter:title" content="Why is my event loop still running?"><meta property="twitter:description" content="Investigations into why my node process stays alive after tests finish running"><meta property="twitter:image" content="https://gowind.github.io/blog-placeholder-1.jpg"><!-- Cloudflare Web Analytics --><script defer src="https://static.cloudflareinsights.com/beacon.min.js" data-cf-beacon="{&quot;token&quot;: &quot;4de85a62d838459fafd8a042c2f1c7c2&quot;}"></script><!-- End Cloudflare Web Analytics --><style>:root{--accent: #2337ff;--accent-dark: #000d8a;--black: 15, 18, 25;--gray: 96, 115, 159;--gray-light: 229, 233, 240;--gray-dark: 34, 41, 57;--gray-gradient: rgba(var(--gray-light), 50%), #fff;--box-shadow: 0 2px 6px rgba(var(--gray), 25%), 0 8px 24px rgba(var(--gray), 33%), 0 16px 32px rgba(var(--gray), 33%)}@font-face{font-family:Atkinson;src:url(/fonts/atkinson-regular.woff) format("woff");font-weight:400;font-style:normal;font-display:swap}@font-face{font-family:Atkinson;src:url(/fonts/atkinson-bold.woff) format("woff");font-weight:700;font-style:normal;font-display:swap}body{font-family:Atkinson,sans-serif;margin:0;padding:0;text-align:left;background:linear-gradient(var(--gray-gradient)) no-repeat;background-size:100% 600px;word-wrap:break-word;overflow-wrap:break-word;color:rgb(var(--gray-dark));font-size:20px;line-height:1.7}main{width:720px;max-width:calc(100% - 2em);margin:auto;padding:3em 1em}h1,h2,h3,h4,h5,h6{margin:0 0 .5rem;color:rgb(var(--black));line-height:1.2}h1{font-size:3.052em}h2{font-size:2.441em}h3{font-size:1.953em}h4{font-size:1.563em}h5{font-size:1.25em}strong,b{font-weight:700}a,a:hover{color:var(--accent)}p{margin-bottom:1em}.prose p{margin-bottom:2em}textarea{width:100%;font-size:16px}input{font-size:16px}table{width:100%}img{max-width:100%;height:auto;border-radius:8px}code{padding:2px 5px;background-color:rgb(var(--gray-light));border-radius:2px}pre{padding:1.5em;border-radius:8px}pre>code{all:unset}blockquote{border-left:4px solid var(--accent);padding:0 0 0 20px;margin:0;font-size:1.333em}hr{border:none;border-top:1px solid rgb(var(--gray-light))}@media (max-width: 720px){body{font-size:18px}main{padding:1em}}.sr-only{border:0;padding:0;margin:0;position:absolute!important;height:1px;width:1px;overflow:hidden;clip:rect(1px 1px 1px 1px);clip:rect(1px,1px,1px,1px);clip-path:inset(50%);white-space:nowrap}.tag{display:inline-block;background-color:#f3f4f6;border-radius:.5rem;padding:.25rem .75rem;margin:0 .5rem .5rem 0;font-size:.875rem;font-weight:600;color:#4b5563}header[data-astro-cid-3ef6ksr2]{margin:0;padding:0 1em;background:#fff;box-shadow:0 2px 8px rgba(var(--black),5%)}h2[data-astro-cid-3ef6ksr2]{margin:0;font-size:1em}nav[data-astro-cid-3ef6ksr2]{display:flex;align-items:center;justify-content:space-between}nav[data-astro-cid-3ef6ksr2] a[data-astro-cid-3ef6ksr2]{padding:1em .5em;color:var(--black);border-bottom:4px solid transparent;text-decoration:none}nav[data-astro-cid-3ef6ksr2] a[data-astro-cid-3ef6ksr2]:hover{color:var(--accent);color:#a12323;animation:shake .2s;animation-iteration-count:1;text-shadow:2px 2px 4px rgba(0,0,0,.2);background-color:#d3cdcd}@keyframes shake{0%{transform:translate(1px,1px) rotate(0)}10%{transform:translate(-1px,-2px) rotate(-5deg)}20%{transform:translate(-3px) rotate(5deg)}30%{transform:translate(3px,2px) rotate(0)}40%{transform:translate(1px,-1px) rotate(5deg)}50%{transform:translate(-1px,2px) rotate(-5deg)}60%{transform:translate(-3px,1px) rotate(0)}70%{transform:translate(3px,1px) rotate(-5deg)}80%{transform:translate(-1px,-1px) rotate(5deg)}90%{transform:translate(1px,2px) rotate(0)}to{transform:translate(1px,-2px) rotate(-5deg)}}nav[data-astro-cid-3ef6ksr2] a[data-astro-cid-3ef6ksr2].active{text-decoration:none;border-bottom-color:#a12323}.social-links[data-astro-cid-3ef6ksr2],.social-links[data-astro-cid-3ef6ksr2] a[data-astro-cid-3ef6ksr2]{display:flex}@media (max-width: 720px){.social-links[data-astro-cid-3ef6ksr2]{display:none}}footer[data-astro-cid-sz7xmlte]{padding:2em 1em 6em;background:linear-gradient(var(--gray-gradient)) no-repeat;color:rgb(var(--gray));text-align:center}.social-links[data-astro-cid-sz7xmlte]{display:flex;justify-content:center;gap:1em;margin-top:1em}.social-links[data-astro-cid-sz7xmlte] a[data-astro-cid-sz7xmlte]{text-decoration:none;color:rgb(var(--gray))}.social-links[data-astro-cid-sz7xmlte] a[data-astro-cid-sz7xmlte]:hover{color:rgb(var(--gray-dark))}
a[data-astro-cid-eimmu3lg]{display:inline-block;text-decoration:none}a[data-astro-cid-eimmu3lg].active{font-weight:bolder;text-decoration:underline}
main[data-astro-cid-bvzihdzo]{width:calc(100% - 2em);max-width:100%;margin:0}.hero-image[data-astro-cid-bvzihdzo]{width:100%}.hero-image[data-astro-cid-bvzihdzo] img[data-astro-cid-bvzihdzo]{display:block;margin:0 auto;border-radius:12px;box-shadow:var(--box-shadow)}.prose[data-astro-cid-bvzihdzo]{width:720px;max-width:calc(100% - 2em);margin:auto;padding:1em;color:rgb(var(--gray-dark))}.title[data-astro-cid-bvzihdzo]{margin-bottom:1em;padding:1em 0;text-align:center;line-height:1}.title[data-astro-cid-bvzihdzo] h1[data-astro-cid-bvzihdzo]{margin:0 0 .5em}.date[data-astro-cid-bvzihdzo]{margin-bottom:.5em;color:rgb(var(--gray))}.last-updated-on[data-astro-cid-bvzihdzo]{font-style:italic}
[data-astro-image]{width:100%;height:auto;object-fit:var(--fit);object-position:var(--pos);aspect-ratio:var(--w) / var(--h)}[data-astro-image=responsive]{max-width:calc(var(--w) * 1px);max-height:calc(var(--h) * 1px)}[data-astro-image=fixed]{width:calc(var(--w) * 1px);height:calc(var(--h) * 1px)}
</style></head> <body data-astro-cid-bvzihdzo> <header data-astro-cid-3ef6ksr2> <nav data-astro-cid-3ef6ksr2> <h2 data-astro-cid-3ef6ksr2><a href="/" data-astro-cid-3ef6ksr2>Govind&#39;s Blog</a></h2> <div class="internal-links" data-astro-cid-3ef6ksr2> <a href="/" data-astro-cid-3ef6ksr2="true" data-astro-cid-eimmu3lg> Home </a>  <a href="/blog" class="active" data-astro-cid-3ef6ksr2="true" data-astro-cid-eimmu3lg> Blog </a>  <a href="/ideas" data-astro-cid-3ef6ksr2="true" data-astro-cid-eimmu3lg> Steal My Ideas </a>  <a href="/editor" data-astro-cid-3ef6ksr2="true" data-astro-cid-eimmu3lg> Image Editor </a>  </div> <div class="social-links" data-astro-cid-3ef6ksr2> <a href="https://x.com/DeepknowledgeU" target="_blank" data-astro-cid-3ef6ksr2> <span class="sr-only" data-astro-cid-3ef6ksr2>Follow Astro on X</span> <svg viewBox="0 0 16 16" aria-hidden="true" width="32" height="32" astro-icon="social/twitter" data-astro-cid-3ef6ksr2><path fill="currentColor" d="M5.026 15c6.038 0 9.341-5.003 9.341-9.334 0-.14 0-.282-.006-.422A6.685 6.685 0 0 0 16 3.542a6.658 6.658 0 0 1-1.889.518 3.301 3.301 0 0 0 1.447-1.817 6.533 6.533 0 0 1-2.087.793A3.286 3.286 0 0 0 7.875 6.03a9.325 9.325 0 0 1-6.767-3.429 3.289 3.289 0 0 0 1.018 4.382A3.323 3.323 0 0 1 .64 6.575v.045a3.288 3.288 0 0 0 2.632 3.218 3.203 3.203 0 0 1-.865.115 3.23 3.23 0 0 1-.614-.057 3.283 3.283 0 0 0 3.067 2.277A6.588 6.588 0 0 1 .78 13.58a6.32 6.32 0 0 1-.78-.045A9.344 9.344 0 0 0 5.026 15z" data-astro-cid-3ef6ksr2></path></svg> </a> <a href="https://github.com/Gowind" target="_blank" data-astro-cid-3ef6ksr2> <span class="sr-only" data-astro-cid-3ef6ksr2>My Github</span> <svg viewBox="0 0 16 16" aria-hidden="true" width="32" height="32" astro-icon="social/github" data-astro-cid-3ef6ksr2><path fill="currentColor" d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.012 8.012 0 0 0 16 8c0-4.42-3.58-8-8-8z" data-astro-cid-3ef6ksr2></path></svg> </a> </div> </nav> </header>  <main data-astro-cid-bvzihdzo> <article data-astro-cid-bvzihdzo> <div class="hero-image" data-astro-cid-bvzihdzo>  </div> <div class="prose" data-astro-cid-bvzihdzo> <div class="title" data-astro-cid-bvzihdzo> <div class="date" data-astro-cid-bvzihdzo> <time datetime="2024-01-10T00:00:00.000Z"> Jan 10, 2024 </time>  </div> <h1 data-astro-cid-bvzihdzo>Why is my event loop still running?</h1> <hr data-astro-cid-bvzihdzo> </div>  <p>You can find the <a href="https://github.com/GoWind/algorithms/tree/master/async_hooks_demo">source</a> to this demo in my repo.</p>
<h4 id="it-all-started-with-tests">It all started with tests</h4>
<p>Well, not a failed test, but I ran into an issue with the node built-in test runner where my unit tests completed, but my test runner wouldn’t exit.
Frustrated, I switched to Jest, which detected that there might be <code>open handles</code> keeping my code from exiting.
Running <code>Jest</code> with <code>--detectOpenHandles</code>, I was able to figure out that there was a Redis connection object in my code
that was opened, but never closed, which prevented the event loop from returning (and thus exiting).</p>
<p>I didn’t really understand why this would keep my event loop from exiting, but digging through the Node API, it
looks like certain objects (like Timers, Sockets etc) can keep the event loop from exiting. An <a href="https://github.com/search?q=repo%3Anodejs%2Fnode%20path%3A%2F%5Edoc%5C%2Fapi%5C%2F%2F%20unref&#x26;type=code"><code>unref</code></a> API function
is used to detach an object from the event loop’s exit condition (and similary a <code>hasRef()</code> fn tells us if an object that isn’t closed can keep an event loop alive or not)</p>
<p>Asking chatGPT how to detect objects that might keep the event loop alive, I stumbled across <a href="https://github.com/mafintosh/why-is-node-running">why-is-node-running</a>, a library that uses Node’s <a href="https://nodejs.org/dist/latest-v20.x/docs/api/async_hooks.html">async hooks</a> to track the lifecycle of async objects.</p>
<p>Using the <a href="https://nodejs.org/dist/latest-v20.x/docs/api/async_hooks.html#initasyncid-type-triggerasyncid-resource"><code>init</code></a> hook, we can hook into async objects (such as Promises, Timeouts, Immediate’s etc) when they are created.
When running my init and destroy hooks, however, the only kind of info I could access was the <code>type</code> of the async object and an <code>id</code> associated with it, but nothing else.</p>
<p>But how do we know which part of the code (is it our code, a library, or an Node JS built-in) created it ?</p>
<p>Here is where <code>why-is-node-running</code> uses an interesting trick. The V8 JS library is used by NodeJS as the JS interpreter/JITcompiler (a lot of the speed of NodeJS can be attributed to just how much wicked fast V8 is). V8 has a API that allows one to customize the <code>Error</code> object in Javascript.
More specifically, V8 adds a <code>.stack</code> property to the Error object in Javascript, that contains the trace of the last 10 (customizable) function frames in the stack, leading upto the function where the Error object was created. The trace (stored at .stack propery) is a formatted string.</p>
<p>For example, here is the value of <code>Error.stack</code> on my Node Repl:</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="js"><code><span class="line"><span style="color:#E1E4E8">$ node</span></span>
<span class="line"><span style="color:#E1E4E8">Welcome to Node.js v20.</span><span style="color:#79B8FF">6.1</span><span style="color:#E1E4E8">.</span></span>
<span class="line"><span style="color:#E1E4E8">Type </span><span style="color:#9ECBFF">".help"</span><span style="color:#E1E4E8"> for more information.</span></span>
<span class="line"><span style="color:#F97583">></span><span style="color:#F97583"> function</span><span style="color:#B392F0"> myFunc</span><span style="color:#E1E4E8">() {</span></span>
<span class="line"><span style="color:#F97583">...</span><span style="color:#F97583">   let</span><span style="color:#E1E4E8"> err </span><span style="color:#F97583">=</span><span style="color:#F97583"> new</span><span style="color:#B392F0"> Error</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">"abced"</span><span style="color:#E1E4E8">);</span></span>
<span class="line"><span style="color:#F97583">...</span><span style="color:#E1E4E8">   console.</span><span style="color:#B392F0">log</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">`${</span><span style="color:#E1E4E8">err</span><span style="color:#9ECBFF">.</span><span style="color:#E1E4E8">stack</span><span style="color:#9ECBFF">}`</span><span style="color:#E1E4E8">);</span></span>
<span class="line"><span style="color:#F97583">...</span><span style="color:#E1E4E8"> }</span></span>
<span class="line"><span style="color:#79B8FF">undefined</span></span>
<span class="line"><span style="color:#F97583">></span><span style="color:#B392F0"> myFunc</span><span style="color:#E1E4E8">();</span></span>
<span class="line"><span style="color:#B392F0">Error</span><span style="color:#E1E4E8">: abced</span></span>
<span class="line"><span style="color:#E1E4E8">    at </span><span style="color:#B392F0">myFunc</span><span style="color:#E1E4E8"> (</span><span style="color:#79B8FF">REPL14</span><span style="color:#E1E4E8">:</span><span style="color:#79B8FF">2</span><span style="color:#E1E4E8">:</span><span style="color:#79B8FF">13</span><span style="color:#E1E4E8">)</span></span>
<span class="line"><span style="color:#E1E4E8">    at </span><span style="color:#B392F0">REPL15</span><span style="color:#E1E4E8">:</span><span style="color:#79B8FF">1</span><span style="color:#E1E4E8">:</span><span style="color:#79B8FF">1</span></span>
<span class="line"><span style="color:#E1E4E8">    at Script.</span><span style="color:#B392F0">runInThisContext</span><span style="color:#E1E4E8"> (node:vm:</span><span style="color:#79B8FF">122</span><span style="color:#E1E4E8">:</span><span style="color:#79B8FF">12</span><span style="color:#E1E4E8">)</span></span>
<span class="line"><span style="color:#E1E4E8">    at REPLServer.</span><span style="color:#B392F0">defaultEval</span><span style="color:#E1E4E8"> (node:repl:</span><span style="color:#79B8FF">593</span><span style="color:#E1E4E8">:</span><span style="color:#79B8FF">29</span><span style="color:#E1E4E8">)</span></span>
<span class="line"><span style="color:#E1E4E8">    at </span><span style="color:#B392F0">bound</span><span style="color:#E1E4E8"> (node:domain:</span><span style="color:#79B8FF">433</span><span style="color:#E1E4E8">:</span><span style="color:#79B8FF">15</span><span style="color:#E1E4E8">)</span></span>
<span class="line"><span style="color:#E1E4E8">    at REPLServer.runBound [</span><span style="color:#F97583">as</span><span style="color:#B392F0"> eval</span><span style="color:#E1E4E8">] (</span><span style="color:#FFAB70">node</span><span style="color:#F97583">:</span><span style="color:#B392F0">domain</span><span style="color:#F97583">:</span><span style="color:#79B8FF">444</span><span style="color:#F97583">:</span><span style="color:#79B8FF">12</span><span style="color:#E1E4E8">)</span></span>
<span class="line"><span style="color:#E1E4E8">    at REPLServer.onLine (</span><span style="color:#FFAB70">node</span><span style="color:#F97583">:</span><span style="color:#B392F0">repl</span><span style="color:#F97583">:</span><span style="color:#79B8FF">923</span><span style="color:#F97583">:</span><span style="color:#79B8FF">10</span><span style="color:#E1E4E8">)</span></span>
<span class="line"><span style="color:#E1E4E8">    at REPLServer.emit (</span><span style="color:#FFAB70">node</span><span style="color:#F97583">:</span><span style="color:#B392F0">events</span><span style="color:#F97583">:</span><span style="color:#79B8FF">526</span><span style="color:#F97583">:</span><span style="color:#79B8FF">35</span><span style="color:#E1E4E8">)</span></span>
<span class="line"><span style="color:#E1E4E8">    at REPLServer.emit (</span><span style="color:#FFAB70">node</span><span style="color:#F97583">:</span><span style="color:#B392F0">domain</span><span style="color:#F97583">:</span><span style="color:#79B8FF">489</span><span style="color:#F97583">:</span><span style="color:#79B8FF">12</span><span style="color:#E1E4E8">)</span></span>
<span class="line"><span style="color:#E1E4E8">    at [_onLine] [as _onLine] (</span><span style="color:#FFAB70">node</span><span style="color:#F97583">:</span><span style="color:#B392F0">internal</span><span style="color:#E1E4E8">/</span><span style="color:#B392F0">readline</span><span style="color:#E1E4E8">/</span><span style="color:#B392F0">interface</span><span style="color:#F97583">:</span><span style="color:#79B8FF">416</span><span style="color:#F97583">:</span><span style="color:#79B8FF">12</span><span style="color:#E1E4E8">)</span></span></code></pre>
<p>The formatted string stored at <code>.stack</code> can be customized. You can do this by attaching a function to the <code>prepareStackTrace</code> property of the error <code>Error</code> object. This is a function of 2 params: The Error object created and an array of callsites, where callsite is a function present in the stack above the fn where the Error object is created. The return value of this <code>prepareStackTrace</code> function is stored in the <code>Error.stack</code> property when <code>new Error(...)</code> is created. You can find more information about this in the <a href="https://v8.dev/docs/stack-trace-api">Stack Trace API</a> documentation.</p>
<p><code>why-is-node-running</code> uses this trick to store a trace of the code where the async object is created. When a new async object (Promise, Timeout etc) is created, the init hooks runs. In the hook fn, the library creates a error object that is tracked along with the async object, thus pointing to where this object was initialized</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="js"><code><span class="line"><span style="color:#B392F0">  init</span><span style="color:#E1E4E8"> (asyncId, type, triggerAsyncId, resource) {</span></span>
<span class="line"><span style="color:#F97583">    if</span><span style="color:#E1E4E8"> (type </span><span style="color:#F97583">===</span><span style="color:#9ECBFF"> 'TIMERWRAP'</span><span style="color:#F97583"> ||</span><span style="color:#E1E4E8"> type </span><span style="color:#F97583">===</span><span style="color:#9ECBFF"> 'PROMISE'</span><span style="color:#E1E4E8">) </span><span style="color:#F97583">return</span></span>
<span class="line"><span style="color:#F97583">    if</span><span style="color:#E1E4E8"> (type </span><span style="color:#F97583">===</span><span style="color:#9ECBFF"> 'PerformanceObserver'</span><span style="color:#F97583"> ||</span><span style="color:#E1E4E8"> type </span><span style="color:#F97583">===</span><span style="color:#9ECBFF"> 'RANDOMBYTESREQUEST'</span><span style="color:#E1E4E8">) </span><span style="color:#F97583">return</span></span>
<span class="line"><span style="color:#F97583">    var</span><span style="color:#E1E4E8"> err </span><span style="color:#F97583">=</span><span style="color:#F97583"> new</span><span style="color:#B392F0"> Error</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">'whatevs'</span><span style="color:#E1E4E8">)</span></span>
<span class="line"><span style="color:#F97583">    var</span><span style="color:#E1E4E8"> stacks </span><span style="color:#F97583">=</span><span style="color:#B392F0"> stackback</span><span style="color:#E1E4E8">(err)</span></span>
<span class="line"><span style="color:#E1E4E8">    active.</span><span style="color:#B392F0">set</span><span style="color:#E1E4E8">(asyncId, {type, stacks, resource})</span></span></code></pre>
<p><code>Stackback</code> is a library that provides some helpers around extracting the info. about the fn frames leading to the Error object</p>
<p>The <code>active</code> object is a global Map mapping each <code>asyncId</code> to its type, the stack of fns in the Error.</p>
<p>When you need the information about why your node process is kept alive, you call the <code>whyIsNodeRunning</code> function, which iterates through the list of all async object created, identifies the ones that can keep the even loop alive (for example, Unresolved Promises do not keep the event loop alive). The objects that can keep the event loop alive, have a <code>hasRef</code> function that returns <code>true</code> when called.  An extract from the <code>why-is-node-running</code> library:</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="js"><code><span class="line"><span style="color:#F97583">function</span><span style="color:#B392F0"> whyIsNodeRunning</span><span style="color:#E1E4E8"> (</span><span style="color:#FFAB70">logger</span><span style="color:#E1E4E8">) {</span></span>
<span class="line"><span style="color:#F97583">  if</span><span style="color:#E1E4E8"> (</span><span style="color:#F97583">!</span><span style="color:#E1E4E8">logger) logger </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> console</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8">  hook.</span><span style="color:#B392F0">disable</span><span style="color:#E1E4E8">()</span></span>
<span class="line"><span style="color:#F97583">  var</span><span style="color:#E1E4E8"> activeResources </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> [</span><span style="color:#F97583">...</span><span style="color:#E1E4E8">active.</span><span style="color:#B392F0">values</span><span style="color:#E1E4E8">()].</span><span style="color:#B392F0">filter</span><span style="color:#E1E4E8">(</span><span style="color:#F97583">function</span><span style="color:#E1E4E8">(</span><span style="color:#FFAB70">r</span><span style="color:#E1E4E8">) {</span></span>
<span class="line"><span style="color:#F97583">    if</span><span style="color:#E1E4E8"> (</span></span>
<span class="line"><span style="color:#F97583">      typeof</span><span style="color:#E1E4E8"> r.resource.hasRef </span><span style="color:#F97583">===</span><span style="color:#9ECBFF"> 'function'</span></span>
<span class="line"><span style="color:#F97583">      &#x26;&#x26;</span><span style="color:#F97583"> !</span><span style="color:#E1E4E8">r.resource.</span><span style="color:#B392F0">hasRef</span><span style="color:#E1E4E8">()</span></span>
<span class="line"><span style="color:#E1E4E8">    ) </span><span style="color:#F97583">return</span><span style="color:#79B8FF"> false</span></span>
<span class="line"><span style="color:#F97583">    return</span><span style="color:#79B8FF"> true</span></span>
<span class="line"><span style="color:#E1E4E8">  })</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8">  logger.</span><span style="color:#B392F0">error</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">'There are %d handle(s) keeping the process running'</span><span style="color:#E1E4E8">, activeResources.</span><span style="color:#79B8FF">length</span><span style="color:#E1E4E8">)</span></span>
<span class="line"><span style="color:#F97583">  for</span><span style="color:#E1E4E8"> (</span><span style="color:#F97583">const</span><span style="color:#79B8FF"> o</span><span style="color:#F97583"> of</span><span style="color:#E1E4E8"> activeResources) </span><span style="color:#B392F0">printStacks</span><span style="color:#E1E4E8">(o)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">  function</span><span style="color:#B392F0"> printStacks</span><span style="color:#E1E4E8"> (</span><span style="color:#FFAB70">o</span><span style="color:#E1E4E8">) {</span></span>
<span class="line"><span style="color:#F97583">    var</span><span style="color:#E1E4E8"> stacks </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> o.stacks.</span><span style="color:#B392F0">slice</span><span style="color:#E1E4E8">(</span><span style="color:#79B8FF">1</span><span style="color:#E1E4E8">).</span><span style="color:#B392F0">filter</span><span style="color:#E1E4E8">(</span><span style="color:#F97583">function</span><span style="color:#E1E4E8"> (</span><span style="color:#FFAB70">s</span><span style="color:#E1E4E8">) {</span></span>
<span class="line"><span style="color:#F97583">      var</span><span style="color:#E1E4E8"> filename </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> s.</span><span style="color:#B392F0">getFileName</span><span style="color:#E1E4E8">()</span></span>
<span class="line"><span style="color:#F97583">      return</span><span style="color:#E1E4E8"> filename </span><span style="color:#F97583">&#x26;&#x26;</span><span style="color:#E1E4E8"> filename.</span><span style="color:#B392F0">indexOf</span><span style="color:#E1E4E8">(sep) </span><span style="color:#F97583">></span><span style="color:#F97583"> -</span><span style="color:#79B8FF">1</span><span style="color:#F97583"> &#x26;&#x26;</span><span style="color:#E1E4E8"> filename.</span><span style="color:#B392F0">indexOf</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">'internal'</span><span style="color:#F97583"> +</span><span style="color:#E1E4E8"> sep) </span><span style="color:#F97583">!==</span><span style="color:#79B8FF"> 0</span></span>
<span class="line"><span style="color:#E1E4E8">    })</span></span></code></pre>
<p>Well if my Node instance is stuck, how do I trigger this function ?</p>
<p>Enter Unix Signals.</p>
<p>We can send a Signal to a process, which triggers a signal handler to handle it. Some Signals (like KILL, SEGV) cannot be handled and the process terminates, but there are standard signals that can be customized and handled by our process. For example, SIGUSR1 and SIGUSR2 can be customized by the program for Interprocess communication or custom signal handling etc (you can also use SIGPIPE, because Node by default ignores SIGPIPE)</p>
<p>In NodeJS, we can setup a signal handler on our process to execute a function when a signal is received. I set up
the signal handler in my demo, to trigger the function that iterates through the map of async objects created to see
what object could possibly keeping the program alive</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="js"><code><span class="line"><span style="color:#E1E4E8">process.</span><span style="color:#B392F0">on</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">'SIGUSR1'</span><span style="color:#E1E4E8">, () </span><span style="color:#F97583">=></span><span style="color:#E1E4E8"> { console.</span><span style="color:#B392F0">log</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">"captured sigterm"</span><span style="color:#E1E4E8">) ; </span><span style="color:#B392F0">showMeTheCulprit</span><span style="color:#E1E4E8">(fd)});</span></span></code></pre>
<h4 id="caveats">Caveats</h4>
<p>Async Hooks have a <a href="https://github.com/nodejs/benchmarking/issues/181">performance impact</a>. It might be prudent to have this instrumentation as an alternate <code>main</code> function of sorts, to be used only when you run into issues and have to debug the program and not running all the time in Production</p>
<h4 id="conclusion">Conclusion</h4>
<p>Researching on this topic was a fantastic way for me to learn a bit more about NodeJS internals and how asynchronous object work :) To more such hacking and learning</p>  </div> </article> </main> <footer data-astro-cid-sz7xmlte> <div class="social-links" data-astro-cid-sz7xmlte> <a href="https://x.com/DeepknowledgeU" target="_blank" data-astro-cid-sz7xmlte> <span class="sr-only" data-astro-cid-sz7xmlte>Follow Astro on X</span> <svg viewBox="0 0 16 16" aria-hidden="true" width="32" height="32" astro-icon="social/twitter" data-astro-cid-sz7xmlte><path fill="currentColor" d="M5.026 15c6.038 0 9.341-5.003 9.341-9.334 0-.14 0-.282-.006-.422A6.685 6.685 0 0 0 16 3.542a6.658 6.658 0 0 1-1.889.518 3.301 3.301 0 0 0 1.447-1.817 6.533 6.533 0 0 1-2.087.793A3.286 3.286 0 0 0 7.875 6.03a9.325 9.325 0 0 1-6.767-3.429 3.289 3.289 0 0 0 1.018 4.382A3.323 3.323 0 0 1 .64 6.575v.045a3.288 3.288 0 0 0 2.632 3.218 3.203 3.203 0 0 1-.865.115 3.23 3.23 0 0 1-.614-.057 3.283 3.283 0 0 0 3.067 2.277A6.588 6.588 0 0 1 .78 13.58a6.32 6.32 0 0 1-.78-.045A9.344 9.344 0 0 0 5.026 15z" data-astro-cid-sz7xmlte></path></svg> </a> <a href="https://github.com/Gowind" target="_blank" data-astro-cid-sz7xmlte> <span class="sr-only" data-astro-cid-sz7xmlte>My Github</span> <svg viewBox="0 0 16 16" aria-hidden="true" width="32" height="32" astro-icon="social/github" data-astro-cid-sz7xmlte><path fill="currentColor" d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.012 8.012 0 0 0 16 8c0-4.42-3.58-8-8-8z" data-astro-cid-sz7xmlte></path></svg> </a> </div> </footer>  </body></html>