<!DOCTYPE html><html lang="en" data-astro-cid-bvzihdzo> <head><!-- Global Metadata --><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1"><link rel="icon" type="image/svg+xml" href="/favicon.svg"><meta name="generator" content="Astro v5.9.1"><!-- Font preloads --><link rel="preload" href="/fonts/atkinson-regular.woff" as="font" type="font/woff" crossorigin><link rel="preload" href="/fonts/atkinson-bold.woff" as="font" type="font/woff" crossorigin><link rel="preload" href="/fonts/saiyan_sans/Saiyan-Sans.ttf" as="font" type="font/ttf" crossorigin><!-- Canonical URL --><link rel="canonical" href="https://gowind.github.io/blog/async_await_transforms_part3/"><!-- Primary Meta Tags --><title>Transforming async await - III, Stepping the Generator</title><meta name="title" content="Transforming async await - III, Stepping the Generator"><meta name="description" content><!-- Open Graph / Facebook --><meta property="og:type" content="website"><meta property="og:url" content="https://gowind.github.io/blog/async_await_transforms_part3/"><meta property="og:title" content="Transforming async await - III, Stepping the Generator"><meta property="og:description" content><meta property="og:image" content="https://gowind.github.io/blog-placeholder-1.jpg"><!-- Twitter --><meta property="twitter:card" content="summary_large_image"><meta property="twitter:url" content="https://gowind.github.io/blog/async_await_transforms_part3/"><meta property="twitter:title" content="Transforming async await - III, Stepping the Generator"><meta property="twitter:description" content><meta property="twitter:image" content="https://gowind.github.io/blog-placeholder-1.jpg"><!-- Cloudflare Web Analytics --><script defer src="https://static.cloudflareinsights.com/beacon.min.js" data-cf-beacon="{&quot;token&quot;: &quot;4de85a62d838459fafd8a042c2f1c7c2&quot;}"></script><!-- End Cloudflare Web Analytics --><style>:root{--accent: #2337ff;--accent-dark: #000d8a;--black: 15, 18, 25;--gray: 96, 115, 159;--gray-light: 229, 233, 240;--gray-dark: 34, 41, 57;--gray-gradient: rgba(var(--gray-light), 50%), #fff;--box-shadow: 0 2px 6px rgba(var(--gray), 25%), 0 8px 24px rgba(var(--gray), 33%), 0 16px 32px rgba(var(--gray), 33%)}@font-face{font-family:Atkinson;src:url(/fonts/atkinson-regular.woff) format("woff");font-weight:400;font-style:normal;font-display:swap}@font-face{font-family:Atkinson;src:url(/fonts/atkinson-bold.woff) format("woff");font-weight:700;font-style:normal;font-display:swap}@font-face{font-family:SaiyanSans;src:url(/js/Saiyan-Sans.HVcRaXbq.ttf) format("truetype");font-weight:400;font-style:normal;font-display:swap}body{font-family:Atkinson,sans-serif;margin:0;padding:0;text-align:left;background:linear-gradient(var(--gray-gradient)) no-repeat;background-size:100% 600px;word-wrap:break-word;overflow-wrap:break-word;color:rgb(var(--gray-dark));font-size:20px;line-height:1.7}main{width:720px;max-width:calc(100% - 2em);margin:auto;padding:3em 1em}h1,h2,h3,h4,h5,h6{margin:0 0 .5rem;color:rgb(var(--black));line-height:1.2}h1{font-size:3.052em}h2{font-size:2.441em}h3{font-size:1.953em}h4{font-size:1.563em}h5{font-size:1.25em}strong,b{font-weight:700}a,a:hover{color:var(--accent)}p{margin-bottom:1em}.prose p{margin-bottom:2em}textarea{width:100%;font-size:16px}input{font-size:16px}table{width:100%}img{max-width:100%;height:auto;border-radius:8px}code{padding:2px 5px;background-color:rgb(var(--gray-light));border-radius:2px}pre{padding:1.5em;border-radius:8px}pre>code{all:unset}blockquote{border-left:4px solid var(--accent);padding:0 0 0 20px;margin:0;font-size:1.333em}hr{border:none;border-top:1px solid rgb(var(--gray-light))}@media (max-width: 720px){body{font-size:18px}main{padding:1em}}.sr-only{border:0;padding:0;margin:0;position:absolute!important;height:1px;width:1px;overflow:hidden;clip:rect(1px 1px 1px 1px);clip:rect(1px,1px,1px,1px);clip-path:inset(50%);white-space:nowrap}.tag{display:inline-block;background-color:#f3f4f6;border-radius:.5rem;padding:.25rem .75rem;margin:0 .5rem .5rem 0;font-size:.875rem;font-weight:600;color:#4b5563}header[data-astro-cid-3ef6ksr2]{margin:0;padding:0 1em;background:#fff;box-shadow:0 2px 8px rgba(var(--black),5%)}h2[data-astro-cid-3ef6ksr2]{margin:0;font-size:1em}nav[data-astro-cid-3ef6ksr2]{display:flex;align-items:baseline;justify-content:space-between}.internal-links[data-astro-cid-3ef6ksr2]{font-family:SaiyanSans,sans-serif;font-spacing:1em;font-size:2rem}nav[data-astro-cid-3ef6ksr2] .internal-links[data-astro-cid-3ef6ksr2]{margin-right:10em}nav[data-astro-cid-3ef6ksr2] a[data-astro-cid-3ef6ksr2]{padding:1em .5em;color:var(--black);border-bottom:4px solid transparent;text-decoration:none}nav[data-astro-cid-3ef6ksr2] a[data-astro-cid-3ef6ksr2]:hover{color:var(--accent);color:red;animation:shake .2s;animation-iteration-count:1;text-shadow:2px 4px rgba(0,0,0,.2);font-weight:bolder}@keyframes shake{0%{transform:translate(1px,1px) rotate(0)}10%{transform:translate(-1px,-2px) rotate(-5deg)}20%{transform:translate(-3px) rotate(5deg)}30%{transform:translate(3px,2px) rotate(0)}40%{transform:translate(1px,-1px) rotate(5deg)}50%{transform:translate(-1px,2px) rotate(-5deg)}60%{transform:translate(-3px,1px) rotate(0)}70%{transform:translate(3px,1px) rotate(-5deg)}80%{transform:translate(-1px,-1px) rotate(5deg)}90%{transform:translate(1px,2px) rotate(0)}to{transform:translate(1px,-2px) rotate(-5deg)}}nav[data-astro-cid-3ef6ksr2] a[data-astro-cid-3ef6ksr2].active{text-decoration:none;border-bottom-color:red}.social-links[data-astro-cid-3ef6ksr2],.social-links[data-astro-cid-3ef6ksr2] a[data-astro-cid-3ef6ksr2]{display:flex}@media (max-width: 720px){.social-links[data-astro-cid-3ef6ksr2]{display:none}}.aura-container[data-astro-cid-3ef6ksr2]{position:relative;display:inline-block;padding:60px}.aura-text[data-astro-cid-3ef6ksr2]{font-size:2.2rem;font-weight:700;font-family:SaiyanSans,sans-serif;color:red;position:relative;z-index:4;-webkit-text-stroke:1px black;letter-spacing:.1em}.aura-text[data-astro-cid-3ef6ksr2] .yellow[data-astro-cid-3ef6ksr2]{color:#ff0}.aura-text[data-astro-cid-3ef6ksr2] .organge[data-astro-cid-3ef6ksr2]{color:orange}.gif-aura[data-astro-cid-3ef6ksr2]{position:absolute;inset:0;background:url(/CFoa1.gif) center/cover no-repeat;z-index:2;mix-blend-mode:screen;opacity:.8}.gif-bg-1[data-astro-cid-3ef6ksr2],.gif-bg-2[data-astro-cid-3ef6ksr2],.gif-bg-3[data-astro-cid-3ef6ksr2],.gif-bg-4[data-astro-cid-3ef6ksr2],.gif-bg-5[data-astro-cid-3ef6ksr2],.gif-bg-6[data-astro-cid-3ef6ksr2],.gif-bg-7[data-astro-cid-3ef6ksr2],.gif-bg-8[data-astro-cid-3ef6ksr2]{position:absolute;width:150px;height:150px;background:url(/CFoa1.gif) center/contain no-repeat;z-index:4;mix-blend-mode:multiply;opacity:.9}.gif-bg-1[data-astro-cid-3ef6ksr2]{top:-5px;left:-5px;transform:rotate(-20deg)}.gif-bg-2[data-astro-cid-3ef6ksr2]{top:-5px;left:25%;transform:rotate(-5deg)}.gif-bg-3[data-astro-cid-3ef6ksr2]{top:-5px;left:50%;transform:rotate(5deg)}.gif-bg-4[data-astro-cid-3ef6ksr2]{top:-15px;right:-30px;transform:rotate(20deg)}.gif-bg-5[data-astro-cid-3ef6ksr2]{bottom:10px;left:-30px;transform:rotate(-160deg)}.gif-bg-6[data-astro-cid-3ef6ksr2]{bottom:10px;left:25%;transform:rotate(-160deg)}.gif-bg-7[data-astro-cid-3ef6ksr2]{bottom:10px;right:25%;transform:rotate(-160deg)}.gif-bg-8[data-astro-cid-3ef6ksr2]{bottom:10px;right:-30px;transform:rotate(160deg)}footer[data-astro-cid-sz7xmlte]{padding:2em 1em 6em;background:linear-gradient(var(--gray-gradient)) no-repeat;color:rgb(var(--gray));text-align:center}.social-links[data-astro-cid-sz7xmlte]{display:flex;justify-content:center;gap:1em;margin-top:1em}.social-links[data-astro-cid-sz7xmlte] a[data-astro-cid-sz7xmlte]{text-decoration:none;color:rgb(var(--gray))}.social-links[data-astro-cid-sz7xmlte] a[data-astro-cid-sz7xmlte]:hover{color:rgb(var(--gray-dark))}
a[data-astro-cid-eimmu3lg]{display:inline-block;text-decoration:none}a[data-astro-cid-eimmu3lg].active{font-weight:bolder;text-decoration:underline}
.scrollrectangle[data-astro-cid-bvzihdzo]{position:fixed;right:20px;width:20px;height:100px;background-color:#2c65d7;border-radius:10%;transition:top .3s ease-out;transform-origin:center center;animation:squeeze 1s infinite}@keyframes squeeze{0%{transform:scaleY(1)}50%{transform:scaleY(1.5)}to{transform:scaleY(1)}}main[data-astro-cid-bvzihdzo]{width:calc(100% - 2em);max-width:100%;margin:0}.hero-image[data-astro-cid-bvzihdzo]{width:100%}.hero-image[data-astro-cid-bvzihdzo] img[data-astro-cid-bvzihdzo]{display:block;margin:0 auto;border-radius:12px;box-shadow:var(--box-shadow)}.prose[data-astro-cid-bvzihdzo]{width:720px;max-width:calc(100% - 2em);margin:auto;padding:1em;color:rgb(var(--gray-dark))}.title[data-astro-cid-bvzihdzo]{margin-bottom:1em;padding:1em 0;text-align:center;line-height:1}.title[data-astro-cid-bvzihdzo] h1[data-astro-cid-bvzihdzo]{margin:0 0 .5em}.date[data-astro-cid-bvzihdzo]{margin-bottom:.5em;color:rgb(var(--gray))}.last-updated-on[data-astro-cid-bvzihdzo]{font-style:italic}
</style></head> <body data-astro-cid-bvzihdzo> <header data-astro-cid-3ef6ksr2> <nav data-astro-cid-3ef6ksr2> <div class="aura-container" data-astro-cid-3ef6ksr2> <div class="gif-bg-1" data-astro-cid-3ef6ksr2></div> <div class="gif-bg-2" data-astro-cid-3ef6ksr2></div> <div class="gif-bg-3" data-astro-cid-3ef6ksr2></div> <h2 class="aura-text" data-astro-cid-3ef6ksr2> <a href="/" data-astro-cid-3ef6ksr2> <span class="yellow" data-astro-cid-3ef6ksr2>Govind's</span> <span class="orange" data-astro-cid-3ef6ksr2>O</span> <span data-astro-cid-3ef6ksr2>Blog</span> </a></h2> </div> <div class="internal-links" data-astro-cid-3ef6ksr2> <a href="/" data-astro-cid-3ef6ksr2="true" data-astro-cid-eimmu3lg> Home </a>  <a href="/blog" class="active" data-astro-cid-3ef6ksr2="true" data-astro-cid-eimmu3lg> Blog </a>  <a href="/ideas" data-astro-cid-3ef6ksr2="true" data-astro-cid-eimmu3lg> Steal My Ideas </a>  <a href="/editor" data-astro-cid-3ef6ksr2="true" data-astro-cid-eimmu3lg> Image Editor </a>  </div> <div class="social-links" data-astro-cid-3ef6ksr2> <a href="https://x.com/DeepknowledgeU" target="_blank" data-astro-cid-3ef6ksr2> <span class="sr-only" data-astro-cid-3ef6ksr2>Follow Astro on X</span> <svg viewBox="0 0 16 16" aria-hidden="true" width="32" height="32" astro-icon="social/twitter" data-astro-cid-3ef6ksr2><path fill="currentColor" d="M5.026 15c6.038 0 9.341-5.003 9.341-9.334 0-.14 0-.282-.006-.422A6.685 6.685 0 0 0 16 3.542a6.658 6.658 0 0 1-1.889.518 3.301 3.301 0 0 0 1.447-1.817 6.533 6.533 0 0 1-2.087.793A3.286 3.286 0 0 0 7.875 6.03a9.325 9.325 0 0 1-6.767-3.429 3.289 3.289 0 0 0 1.018 4.382A3.323 3.323 0 0 1 .64 6.575v.045a3.288 3.288 0 0 0 2.632 3.218 3.203 3.203 0 0 1-.865.115 3.23 3.23 0 0 1-.614-.057 3.283 3.283 0 0 0 3.067 2.277A6.588 6.588 0 0 1 .78 13.58a6.32 6.32 0 0 1-.78-.045A9.344 9.344 0 0 0 5.026 15z" data-astro-cid-3ef6ksr2></path></svg> </a> <a href="https://github.com/Gowind" target="_blank" data-astro-cid-3ef6ksr2> <span class="sr-only" data-astro-cid-3ef6ksr2>My Github</span> <svg viewBox="0 0 16 16" aria-hidden="true" width="32" height="32" astro-icon="social/github" data-astro-cid-3ef6ksr2><path fill="currentColor" d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.012 8.012 0 0 0 16 8c0-4.42-3.58-8-8-8z" data-astro-cid-3ef6ksr2></path></svg> </a> </div> </nav> </header>  <main data-astro-cid-bvzihdzo> <article data-astro-cid-bvzihdzo> <div class="scrollrectangle" data-astro-cid-bvzihdzo></div> <script type="module">const o=document.querySelector(".ball"),c=document.querySelector("header"),r=document.documentElement.scrollHeight-window.innerHeight,t=c?.offsetHeight;o.style.top=`${t+100}px`;window.addEventListener("scroll",()=>{const n=window.scrollY/r,l=window.innerHeight-100;let e=n*l;e=e>=t+100?e:t+100,o.style.top=`${e}px`});</script> <div class="hero-image" data-astro-cid-bvzihdzo> <img width="1020" height="510" src="/blog-placeholder-5.jpg" alt="" data-astro-cid-bvzihdzo> </div> <div class="prose" data-astro-cid-bvzihdzo> <div class="title" data-astro-cid-bvzihdzo> <div class="date" data-astro-cid-bvzihdzo> <time datetime="2024-02-18T00:00:00.000Z"> Feb 18, 2024 </time>  </div> <h1 data-astro-cid-bvzihdzo>Transforming async await - III, Stepping the Generator</h1> <hr data-astro-cid-bvzihdzo> </div>  <p>This is a continuation of a three part series: <a href="async_await_transforms_part1.html">Part I</a>, <a href="async_await_transforms_part2.html">Part II</a></p>
<p>Let us go back to the original example:</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="js"><code><span class="line"><span style="color:#F97583">async</span><span style="color:#F97583"> function</span><span style="color:#B392F0"> getTextOrBust</span><span style="color:#E1E4E8">() {</span></span>
<span class="line"><span style="color:#F97583">	const</span><span style="color:#79B8FF"> resp</span><span style="color:#F97583"> =</span><span style="color:#F97583"> await</span><span style="color:#B392F0"> fetch</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">"https://google.com"</span><span style="color:#E1E4E8">);</span></span>
<span class="line"><span style="color:#F97583">	if</span><span style="color:#E1E4E8">(resp.ok) {</span></span>
<span class="line"><span style="color:#F97583">		const</span><span style="color:#79B8FF"> body</span><span style="color:#F97583"> =</span><span style="color:#F97583"> await</span><span style="color:#E1E4E8"> resp.</span><span style="color:#B392F0">text</span><span style="color:#E1E4E8">();</span></span>
<span class="line"><span style="color:#F97583">		return</span><span style="color:#E1E4E8"> body;</span></span>
<span class="line"><span style="color:#E1E4E8">	} </span><span style="color:#F97583">else</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#F97583">		throw</span><span style="color:#B392F0"> Error</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">"Cannot fetch goog"</span><span style="color:#E1E4E8">);</span></span>
<span class="line"><span style="color:#E1E4E8">	}</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span></code></pre>
<p>This was re-written as</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="js"><code><span class="line"><span style="color:#F97583">function</span><span style="color:#B392F0"> getTextOrBust</span><span style="color:#E1E4E8">() {</span></span>
<span class="line"><span style="color:#F97583">    return</span><span style="color:#B392F0"> __awaiter</span><span style="color:#E1E4E8">(</span><span style="color:#79B8FF">this</span><span style="color:#E1E4E8">, </span><span style="color:#F97583">void</span><span style="color:#79B8FF"> 0</span><span style="color:#E1E4E8">, </span><span style="color:#F97583">void</span><span style="color:#79B8FF"> 0</span><span style="color:#E1E4E8">, </span><span style="color:#F97583">function*</span><span style="color:#E1E4E8"> () {</span></span>
<span class="line"><span style="color:#F97583">        const</span><span style="color:#79B8FF"> resp</span><span style="color:#F97583"> =</span><span style="color:#F97583"> yield</span><span style="color:#B392F0"> fetch</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">"https://google.com"</span><span style="color:#E1E4E8">);</span></span>
<span class="line"><span style="color:#F97583">        if</span><span style="color:#E1E4E8"> (resp.ok) {</span></span>
<span class="line"><span style="color:#F97583">            const</span><span style="color:#79B8FF"> body</span><span style="color:#F97583"> =</span><span style="color:#F97583"> yield</span><span style="color:#E1E4E8"> resp.</span><span style="color:#B392F0">text</span><span style="color:#E1E4E8">();</span></span>
<span class="line"><span style="color:#F97583">            return</span><span style="color:#E1E4E8"> body;</span></span>
<span class="line"><span style="color:#E1E4E8">        }</span></span>
<span class="line"><span style="color:#F97583">        else</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#F97583">            throw</span><span style="color:#B392F0"> Error</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">"Cannot fetch goog"</span><span style="color:#E1E4E8">);</span></span>
<span class="line"><span style="color:#E1E4E8">        }</span></span>
<span class="line"><span style="color:#E1E4E8">    });</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span></code></pre>
<p>Notice how when we <code>await</code> a Promise in our original code, we now <code>yield</code> the same Promise in our transpiled code ? And that <code>async function</code>s return a <code>Promise&#x3C;ReturnType></code> and similarly, our Transformed function returns a Promise ?</p>
<ol>
<li>The body of our original function is transformed from a normal fn’s body to that of a Generator Function.</li>
<li>We wrap the Generator Fn inside an <code>__awaiter</code> that knows how to resume our body after an operation it is waiting for, is complete.</li>
</ol>
<p>The first iteration of our <code>__awaiter</code> might have looked something like this:</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="js"><code><span class="line"><span style="color:#F97583">function</span><span style="color:#B392F0"> __awaiter</span><span style="color:#E1E4E8">(..., </span><span style="color:#FFAB70">generatorFn</span><span style="color:#E1E4E8">) {</span></span>
<span class="line"><span style="color:#F97583">		let</span><span style="color:#E1E4E8"> generator </span><span style="color:#F97583">=</span><span style="color:#B392F0"> generatorFn</span><span style="color:#E1E4E8">();</span></span>
<span class="line"><span style="color:#F97583">		let</span><span style="color:#E1E4E8"> val </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> generator.</span><span style="color:#B392F0">next</span><span style="color:#E1E4E8">();</span></span>
<span class="line"><span style="color:#F97583">		if</span><span style="color:#E1E4E8">(generator.done) {</span></span>
<span class="line"><span style="color:#F97583">			return</span><span style="color:#79B8FF"> Promise</span><span style="color:#E1E4E8">((</span><span style="color:#FFAB70">res</span><span style="color:#E1E4E8">, </span><span style="color:#FFAB70">rej</span><span style="color:#E1E4E8">) </span><span style="color:#F97583">=></span><span style="color:#E1E4E8"> { </span><span style="color:#B392F0">res</span><span style="color:#E1E4E8">(val.value)})</span></span>
<span class="line"><span style="color:#E1E4E8">		} </span><span style="color:#F97583">else</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#F97583">			if</span><span style="color:#E1E4E8">(</span><span style="color:#F97583">!</span><span style="color:#E1E4E8"> val.value </span><span style="color:#F97583">instanceof</span><span style="color:#B392F0"> Promise</span><span style="color:#E1E4E8">) {</span></span>
<span class="line"><span style="color:#79B8FF">				Promise</span><span style="color:#E1E4E8">((</span><span style="color:#FFAB70">resolve</span><span style="color:#E1E4E8">) </span><span style="color:#F97583">=></span><span style="color:#B392F0"> resolve</span><span style="color:#E1E4E8">(val.value)).</span><span style="color:#B392F0">then</span><span style="color:#E1E4E8">((v)</span></span>
<span class="line"><span style="color:#F97583">				=></span><span style="color:#E1E4E8"> generator.</span><span style="color:#B392F0">next</span><span style="color:#E1E4E8">(v))</span></span>
<span class="line"><span style="color:#E1E4E8">			} </span><span style="color:#F97583">else</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#E1E4E8">				val.value.</span><span style="color:#B392F0">then</span><span style="color:#E1E4E8">((</span><span style="color:#FFAB70">v</span><span style="color:#E1E4E8">) </span><span style="color:#F97583">=></span><span style="color:#E1E4E8"> generator.</span><span style="color:#B392F0">next</span><span style="color:#E1E4E8">(v))</span></span>
<span class="line"><span style="color:#E1E4E8">			}</span></span>
<span class="line"><span style="color:#E1E4E8">		}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8">}</span></span></code></pre>
<p>So what are we doing here ?</p>
<ol>
<li>Run our function (Generator instance)</li>
<li>If the Generator instance runs till completion, return a Promise that resolves with the value of our generator instance.</li>
<li>Else, The Generator instance is waiting for a Promise to resolve. Chain the <code>generator.next()</code> to the Promise using <code>.then</code> so that we can resume our generator with the resolved value.</li>
</ol>
<p>Running the example:</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="js"><code><span class="line"><span style="color:#F97583"> return</span><span style="color:#B392F0"> __awaiter</span><span style="color:#E1E4E8">(</span><span style="color:#79B8FF">this</span><span style="color:#E1E4E8">, </span><span style="color:#F97583">void</span><span style="color:#79B8FF"> 0</span><span style="color:#E1E4E8">, </span><span style="color:#F97583">void</span><span style="color:#79B8FF"> 0</span><span style="color:#E1E4E8">, </span><span style="color:#F97583">function*</span><span style="color:#E1E4E8"> () {</span></span>
<span class="line"><span style="color:#F97583">        const</span><span style="color:#79B8FF"> resp</span><span style="color:#F97583"> =</span><span style="color:#F97583"> yield</span><span style="color:#B392F0"> fetch</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">"https://google.com"</span><span style="color:#E1E4E8">);</span></span>
<span class="line"><span style="color:#F97583">        if</span><span style="color:#E1E4E8"> (resp.ok) {</span></span>
<span class="line"><span style="color:#F97583">            const</span><span style="color:#79B8FF"> body</span><span style="color:#F97583"> =</span><span style="color:#F97583"> yield</span><span style="color:#E1E4E8"> resp.</span><span style="color:#B392F0">text</span><span style="color:#E1E4E8">();</span></span>
<span class="line"><span style="color:#F97583">            return</span><span style="color:#E1E4E8"> body;</span></span>
<span class="line"><span style="color:#E1E4E8">        }</span></span>
<span class="line"><span style="color:#F97583">        else</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#F97583">            throw</span><span style="color:#B392F0"> Error</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">"Cannot fetch goog"</span><span style="color:#E1E4E8">);</span></span>
<span class="line"><span style="color:#E1E4E8">        }</span></span>
<span class="line"><span style="color:#E1E4E8">    });</span></span></code></pre>
<ol>
<li>We run <code>function*</code> inside <code>__awaiter</code> by calling <code>.next()</code> first.</li>
<li>we reach <code>const resp = yield fetch(...)</code> . We suspend the generator instance with the return value of <code>fetch</code>: A promise.</li>
<li>We check if <code>generator.done</code> is true. It is false, as we haven’t finished running the body of the generator instance.</li>
<li>We therefore chain our generator to resume once the <code>fetch</code> Promise resolves , with the value resolved by the fetch Promise.</li>
<li>Execution resumes at <code>const resp ...</code> . By now fetch Promise has resolved and the generator is resume with the value of this Promise, so resp will contain the actual response object.</li>
<li>We then proceed till we hit the next <code>yield</code> or return statement.</li>
</ol>
<h3 id="what-happens-when-we-await-multiple-times-in-our-async-fn">What happens when we await multiple times in our async fn ?</h3>
<p>Note that in the <code>__awaiter</code> implementation above , we resume  <code>Promise.then((v) => { generator.next(v)}))</code> only once, but our Generator Function can have any number of yield expressions in the body. How do we ensure that we handle an arbitrarily large body with multiple <code>yield</code> statements ? (Notice that both fetch and response.text() return Promises, so we need to suspend and resume our generators twice)</p>
<p>We do that by being a bit clever</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="js"><code><span class="line"><span style="color:#F97583">var</span><span style="color:#E1E4E8"> __awaiter </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> (</span><span style="color:#79B8FF">this</span><span style="color:#F97583"> &#x26;&#x26;</span><span style="color:#79B8FF"> this</span><span style="color:#E1E4E8">.__awaiter) </span><span style="color:#F97583">||</span><span style="color:#F97583"> function</span><span style="color:#E1E4E8"> (</span><span style="color:#FFAB70">thisArg</span><span style="color:#E1E4E8">, </span><span style="color:#FFAB70">_arguments</span><span style="color:#E1E4E8">, </span><span style="color:#FFAB70">P</span><span style="color:#E1E4E8">, </span><span style="color:#FFAB70">generator</span><span style="color:#E1E4E8">) {</span></span>
<span class="line"><span style="color:#6A737D">    // if value is not a Promise, then return a Promise that resolves with value</span></span>
<span class="line"><span style="color:#6A737D">    // else return value as it is</span></span>
<span class="line"><span style="color:#F97583">    function</span><span style="color:#B392F0"> adopt</span><span style="color:#E1E4E8">(</span><span style="color:#FFAB70">value</span><span style="color:#E1E4E8">) { </span></span>
<span class="line"><span style="color:#F97583">        return</span><span style="color:#E1E4E8"> value </span><span style="color:#F97583">instanceof</span><span style="color:#B392F0"> P</span><span style="color:#F97583"> ?</span><span style="color:#E1E4E8"> value </span><span style="color:#F97583">:</span><span style="color:#F97583"> new</span><span style="color:#B392F0"> P</span><span style="color:#E1E4E8">(</span><span style="color:#F97583">function</span><span style="color:#E1E4E8"> (</span><span style="color:#FFAB70">resolve</span><span style="color:#E1E4E8">) { </span><span style="color:#B392F0">resolve</span><span style="color:#E1E4E8">(value); }); </span></span>
<span class="line"><span style="color:#E1E4E8">    }</span></span>
<span class="line"><span style="color:#6A737D">    // turns the return value of any fn passed into a Promise</span></span>
<span class="line"><span style="color:#F97583">    return</span><span style="color:#F97583"> new</span><span style="color:#E1E4E8"> (</span><span style="color:#79B8FF">P</span><span style="color:#F97583"> ||</span><span style="color:#E1E4E8"> (</span><span style="color:#79B8FF">P</span><span style="color:#F97583"> =</span><span style="color:#79B8FF"> Promise</span><span style="color:#E1E4E8">))(</span><span style="color:#F97583">function</span><span style="color:#E1E4E8"> (</span><span style="color:#FFAB70">resolve</span><span style="color:#E1E4E8">, </span><span style="color:#FFAB70">reject</span><span style="color:#E1E4E8">) {</span></span>
<span class="line"><span style="color:#6A737D">        // create a Generator Instance out of our given fn body </span></span>
<span class="line"><span style="color:#F97583">        const</span><span style="color:#79B8FF"> genInstance</span><span style="color:#F97583"> =</span><span style="color:#E1E4E8"> generator.</span><span style="color:#B392F0">apply</span><span style="color:#E1E4E8">(thisArg, _arguments </span><span style="color:#F97583">||</span><span style="color:#E1E4E8"> []);</span></span>
<span class="line"><span style="color:#E1E4E8">        </span></span>
<span class="line"><span style="color:#F97583">        const</span><span style="color:#B392F0"> fulfilled</span><span style="color:#F97583"> =</span><span style="color:#E1E4E8"> (</span><span style="color:#FFAB70">value</span><span style="color:#E1E4E8">) </span><span style="color:#F97583">=></span><span style="color:#E1E4E8"> { </span><span style="color:#F97583">try</span><span style="color:#E1E4E8"> { </span></span>
<span class="line"><span style="color:#B392F0">                      step</span><span style="color:#E1E4E8">(genInstance.</span><span style="color:#B392F0">next</span><span style="color:#E1E4E8">(value)); </span></span>
<span class="line"><span style="color:#E1E4E8">                    } </span><span style="color:#F97583">catch</span><span style="color:#E1E4E8"> (e) { </span><span style="color:#B392F0">reject</span><span style="color:#E1E4E8">(e); }</span></span>
<span class="line"><span style="color:#E1E4E8">        } </span></span>
<span class="line"><span style="color:#F97583">        const</span><span style="color:#B392F0"> rejected</span><span style="color:#F97583"> =</span><span style="color:#E1E4E8"> (</span><span style="color:#FFAB70">value</span><span style="color:#E1E4E8">) </span><span style="color:#F97583">=></span><span style="color:#E1E4E8"> { </span><span style="color:#F97583">try</span><span style="color:#E1E4E8"> { </span><span style="color:#B392F0">step</span><span style="color:#E1E4E8">(genInstance[</span><span style="color:#9ECBFF">"throw"</span><span style="color:#E1E4E8">](value)); } </span><span style="color:#F97583">catch</span><span style="color:#E1E4E8"> (e) { </span><span style="color:#B392F0">reject</span><span style="color:#E1E4E8">(e); } }</span></span>
<span class="line"><span style="color:#E1E4E8">        </span></span>
<span class="line"><span style="color:#F97583">        function</span><span style="color:#B392F0"> step</span><span style="color:#E1E4E8">(</span><span style="color:#FFAB70">result</span><span style="color:#E1E4E8">) { </span></span>
<span class="line"><span style="color:#F97583">            if</span><span style="color:#E1E4E8">(result.done) { </span></span>
<span class="line"><span style="color:#B392F0">              resolve</span><span style="color:#E1E4E8">(result.value) </span></span>
<span class="line"><span style="color:#E1E4E8">            } </span><span style="color:#F97583">else</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#B392F0">              adopt</span><span style="color:#E1E4E8">(result.value).</span><span style="color:#B392F0">then</span><span style="color:#E1E4E8">(fulfilled, rejected); </span></span>
<span class="line"><span style="color:#E1E4E8">            }</span></span>
<span class="line"><span style="color:#E1E4E8">        }</span></span>
<span class="line"><span style="color:#B392F0">        step</span><span style="color:#E1E4E8">(genInstance.</span><span style="color:#B392F0">next</span><span style="color:#E1E4E8">());</span></span>
<span class="line"><span style="color:#E1E4E8">    });</span></span>
<span class="line"><span style="color:#E1E4E8">};</span></span></code></pre>
<p>Lets start with top level statements that will be executed :</p>
<ol>
<li><code>return new ((P || (P = Promise))(function (resolve, reject)..</code> runs first</li>
<li>It first creates a <code>const genInstance</code> Generator Instance</li>
<li>Then <code>step(genInstance.next())</code> is executed</li>
<li><code>step(result)</code> checks if our generator instance is <code>done</code>. If there are no <code>await</code> statements in the original code (which are replaced with <code>yield</code> in the transpiled code), it runs to completion , thus setting <code>done</code> to true. <code>step</code> then resolves the Promise from 1. with the value of our generator instance</li>
<li>if <code>result.done</code> is false, it means we probably hit a <code>yield/await</code> statement that needs a Promise to resolve. since <code>yield fetch(..)</code> will return a Promise, <code>result.value</code> is a Promise. <code>adopt(result.value).then(fulfilled, rejected);</code> chains our generator to resume after the Promise is resolved.</li>
</ol>
<p>The lines we have to pay attention to most is <code>const fulfilled = (value) {...}</code> and in the <code>else</code> clause in the function <code>step</code></p>
<p>When a promise returned by <code>yield fetch</code> or <code>yield resp.text()</code> is <code>adopt</code>ed , we need to <code>step</code> the generator, not just do <code>generator.next()</code>. The function <code>step</code> is rightly named so, as it steps an execution of the generator and if the generator isn’t done, sets itself up recursively to be called again and again till the generator is completed.</p>
<p>This recursive stepping is captured in the function <code>fulfilled</code>:</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="js"><code><span class="line"><span style="color:#F97583">const</span><span style="color:#B392F0"> fulfilled</span><span style="color:#F97583"> =</span><span style="color:#E1E4E8"> (</span><span style="color:#FFAB70">value</span><span style="color:#E1E4E8">) </span><span style="color:#F97583">=></span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#F97583">	try</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#B392F0">	  step</span><span style="color:#E1E4E8">(genInstance.</span><span style="color:#B392F0">next</span><span style="color:#E1E4E8">(value)); </span><span style="color:#6A737D">// recursive step</span></span>
<span class="line"><span style="color:#E1E4E8">	} </span><span style="color:#F97583">catch</span><span style="color:#E1E4E8"> (e) {</span></span>
<span class="line"><span style="color:#B392F0">		reject</span><span style="color:#E1E4E8">(e);  </span><span style="color:#6A737D">// reject our top level Promise if we encounter errors during</span></span>
<span class="line"><span style="color:#6A737D">			        // execution</span></span>
<span class="line"><span style="color:#E1E4E8">	}</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span>
<span class="line"><span style="color:#F97583">function</span><span style="color:#B392F0"> step</span><span style="color:#E1E4E8">(</span><span style="color:#FFAB70">result</span><span style="color:#E1E4E8">) { </span></span>
<span class="line"><span style="color:#F97583">	if</span><span style="color:#E1E4E8">(result.done) { </span></span>
<span class="line"><span style="color:#B392F0">	    resolve</span><span style="color:#E1E4E8">(result.value) </span></span>
<span class="line"><span style="color:#E1E4E8">    } </span><span style="color:#F97583">else</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#6A737D">	    // fulfiled will call step again, thus stepping until at some point</span></span>
<span class="line"><span style="color:#6A737D">	    // result.done is true, thus breaking the recursion</span></span>
<span class="line"><span style="color:#B392F0">	    adopt</span><span style="color:#E1E4E8">(result.value).</span><span style="color:#B392F0">then</span><span style="color:#E1E4E8">(fulfilled, rejected); </span></span>
<span class="line"><span style="color:#E1E4E8">    }</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span></code></pre>
<p>If we remove all the noise in our <code>__awaiter</code>, keeping the above recursion in mind, we can see essentially the gist of how an <code>async function</code> with <code>await</code> statements can be transformed into a generator that we step through until it is done, <code>yield</code> at every Promise (await) and resuming once the Promise is resolved :</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="js"><code><span class="line"><span style="color:#F97583">var</span><span style="color:#B392F0"> __awaiter</span><span style="color:#F97583"> =</span><span style="color:#F97583"> function</span><span style="color:#E1E4E8"> (</span><span style="color:#FFAB70">thisArg</span><span style="color:#E1E4E8">, </span><span style="color:#FFAB70">_arguments</span><span style="color:#E1E4E8">, </span><span style="color:#FFAB70">P</span><span style="color:#E1E4E8">, </span><span style="color:#FFAB70">generator</span><span style="color:#E1E4E8">) {</span></span>
<span class="line"><span style="color:#E1E4E8">    </span></span>
<span class="line"><span style="color:#6A737D">    // turns the return value of any fn passed into a Promise</span></span>
<span class="line"><span style="color:#F97583">    return</span><span style="color:#F97583"> new</span><span style="color:#E1E4E8"> (</span><span style="color:#79B8FF">P</span><span style="color:#F97583"> ||</span><span style="color:#E1E4E8"> (</span><span style="color:#79B8FF">P</span><span style="color:#F97583"> =</span><span style="color:#79B8FF"> Promise</span><span style="color:#E1E4E8">))(</span><span style="color:#F97583">function</span><span style="color:#E1E4E8"> (</span><span style="color:#FFAB70">resolve</span><span style="color:#E1E4E8">, </span><span style="color:#FFAB70">reject</span><span style="color:#E1E4E8">) {</span></span>
<span class="line"><span style="color:#6A737D">        // create a Generator Instance out of our given fn body </span></span>
<span class="line"><span style="color:#F97583">        const</span><span style="color:#79B8FF"> genInstance</span><span style="color:#F97583"> =</span><span style="color:#E1E4E8"> generator.</span><span style="color:#B392F0">apply</span><span style="color:#E1E4E8">(thisArg, _arguments </span><span style="color:#F97583">||</span><span style="color:#E1E4E8"> []);</span></span>
<span class="line"><span style="color:#6A737D">        // function step(result){ if(result.done) { resolve(result.value)} else {...}}</span></span>
<span class="line"><span style="color:#B392F0">        step</span><span style="color:#E1E4E8">(genInstance.</span><span style="color:#B392F0">next</span><span style="color:#E1E4E8">());</span></span>
<span class="line"><span style="color:#E1E4E8">    });</span></span>
<span class="line"><span style="color:#E1E4E8">};</span></span></code></pre>
<h3 id="conclusion">Conclusion</h3>
<p>async/await in Javascript can be implemented using Generators. For a long time I wondered how it was done, but turns out the transpiled code is surprisingly understandable. The only tricky part is to grok how the recursive stepping is setup, using <code>step</code> and <code>fulfilled</code> (which in return calls step).
The best way to grok this is by running the <a href="https://github.com/GoWind/algorithms/blob/master/fetch_transformer.js">snippet</a> under a Debugger and setting a breakpoint in the <code>fulfilled</code> and <code>step</code> fns. The best way to understand a piece of code is to simulate it step by step and inspect the results, just like the await transformer does !</p>  </div> </article> </main> <footer data-astro-cid-sz7xmlte> <div class="social-links" data-astro-cid-sz7xmlte> <a href="https://x.com/DeepknowledgeU" target="_blank" data-astro-cid-sz7xmlte> <span class="sr-only" data-astro-cid-sz7xmlte>Follow Astro on X</span> <svg viewBox="0 0 16 16" aria-hidden="true" width="32" height="32" astro-icon="social/twitter" data-astro-cid-sz7xmlte><path fill="currentColor" d="M5.026 15c6.038 0 9.341-5.003 9.341-9.334 0-.14 0-.282-.006-.422A6.685 6.685 0 0 0 16 3.542a6.658 6.658 0 0 1-1.889.518 3.301 3.301 0 0 0 1.447-1.817 6.533 6.533 0 0 1-2.087.793A3.286 3.286 0 0 0 7.875 6.03a9.325 9.325 0 0 1-6.767-3.429 3.289 3.289 0 0 0 1.018 4.382A3.323 3.323 0 0 1 .64 6.575v.045a3.288 3.288 0 0 0 2.632 3.218 3.203 3.203 0 0 1-.865.115 3.23 3.23 0 0 1-.614-.057 3.283 3.283 0 0 0 3.067 2.277A6.588 6.588 0 0 1 .78 13.58a6.32 6.32 0 0 1-.78-.045A9.344 9.344 0 0 0 5.026 15z" data-astro-cid-sz7xmlte></path></svg> </a> <a href="https://github.com/Gowind" target="_blank" data-astro-cid-sz7xmlte> <span class="sr-only" data-astro-cid-sz7xmlte>My Github</span> <svg viewBox="0 0 16 16" aria-hidden="true" width="32" height="32" astro-icon="social/github" data-astro-cid-sz7xmlte><path fill="currentColor" d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.012 8.012 0 0 0 16 8c0-4.42-3.58-8-8-8z" data-astro-cid-sz7xmlte></path></svg> </a> </div> </footer>  </body></html>