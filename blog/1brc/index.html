<!DOCTYPE html><html lang="en" data-astro-cid-bvzihdzo> <head><!-- Global Metadata --><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1"><link rel="icon" type="image/svg+xml" href="/favicon.svg"><meta name="generator" content="Astro v5.9.1"><!-- Font preloads --><link rel="preload" href="/fonts/atkinson-regular.woff" as="font" type="font/woff" crossorigin><link rel="preload" href="/fonts/atkinson-bold.woff" as="font" type="font/woff" crossorigin><link rel="preload" href="/fonts/saiyan_sans/Saiyan-Sans.ttf" as="font" type="font/ttf" crossorigin><!-- Canonical URL --><link rel="canonical" href="https://gowind.github.io/blog/1brc/"><!-- Primary Meta Tags --><title>From 500 secs to 3.5 - The 1brc Challenge</title><meta name="title" content="From 500 secs to 3.5 - The 1brc Challenge"><meta name="description" content="A journey of optmizing code to go brrr"><!-- Open Graph / Facebook --><meta property="og:type" content="website"><meta property="og:url" content="https://gowind.github.io/blog/1brc/"><meta property="og:title" content="From 500 secs to 3.5 - The 1brc Challenge"><meta property="og:description" content="A journey of optmizing code to go brrr"><meta property="og:image" content="https://gowind.github.io/blog-placeholder-1.jpg"><!-- Twitter --><meta property="twitter:card" content="summary_large_image"><meta property="twitter:url" content="https://gowind.github.io/blog/1brc/"><meta property="twitter:title" content="From 500 secs to 3.5 - The 1brc Challenge"><meta property="twitter:description" content="A journey of optmizing code to go brrr"><meta property="twitter:image" content="https://gowind.github.io/blog-placeholder-1.jpg"><!-- Cloudflare Web Analytics --><script defer src="https://static.cloudflareinsights.com/beacon.min.js" data-cf-beacon="{&quot;token&quot;: &quot;4de85a62d838459fafd8a042c2f1c7c2&quot;}"></script><!-- End Cloudflare Web Analytics --><style>:root{--accent: #2337ff;--accent-dark: #000d8a;--black: 15, 18, 25;--gray: 96, 115, 159;--gray-light: 229, 233, 240;--gray-dark: 34, 41, 57;--gray-gradient: rgba(var(--gray-light), 50%), #fff;--box-shadow: 0 2px 6px rgba(var(--gray), 25%), 0 8px 24px rgba(var(--gray), 33%), 0 16px 32px rgba(var(--gray), 33%)}@font-face{font-family:Atkinson;src:url(/fonts/atkinson-regular.woff) format("woff");font-weight:400;font-style:normal;font-display:swap}@font-face{font-family:Atkinson;src:url(/fonts/atkinson-bold.woff) format("woff");font-weight:700;font-style:normal;font-display:swap}@font-face{font-family:SaiyanSans;src:url(/js/Saiyan-Sans.HVcRaXbq.ttf) format("truetype");font-weight:400;font-style:normal;font-display:swap}body{font-family:Atkinson,sans-serif;margin:0;padding:0;text-align:left;background:linear-gradient(var(--gray-gradient)) no-repeat;background-size:100% 600px;word-wrap:break-word;overflow-wrap:break-word;color:rgb(var(--gray-dark));font-size:20px;line-height:1.7}main{width:720px;max-width:calc(100% - 2em);margin:auto;padding:3em 1em}h1,h2,h3,h4,h5,h6{margin:0 0 .5rem;color:rgb(var(--black));line-height:1.2}h1{font-size:3.052em}h2{font-size:2.441em}h3{font-size:1.953em}h4{font-size:1.563em}h5{font-size:1.25em}strong,b{font-weight:700}a,a:hover{color:var(--accent)}p{margin-bottom:1em}.prose p{margin-bottom:2em}textarea{width:100%;font-size:16px}input{font-size:16px}table{width:100%}img{max-width:100%;height:auto;border-radius:8px}code{padding:2px 5px;background-color:rgb(var(--gray-light));border-radius:2px}pre{padding:1.5em;border-radius:8px}pre>code{all:unset}blockquote{border-left:4px solid var(--accent);padding:0 0 0 20px;margin:0;font-size:1.333em}hr{border:none;border-top:1px solid rgb(var(--gray-light))}@media (max-width: 720px){body{font-size:18px}main{padding:1em}}.sr-only{border:0;padding:0;margin:0;position:absolute!important;height:1px;width:1px;overflow:hidden;clip:rect(1px 1px 1px 1px);clip:rect(1px,1px,1px,1px);clip-path:inset(50%);white-space:nowrap}.tag{display:inline-block;background-color:#f3f4f6;border-radius:.5rem;padding:.25rem .75rem;margin:0 .5rem .5rem 0;font-size:.875rem;font-weight:600;color:#4b5563}header[data-astro-cid-3ef6ksr2]{margin:0;padding:0 1em;background:#fff;box-shadow:0 2px 8px rgba(var(--black),5%)}h2[data-astro-cid-3ef6ksr2]{margin:0;font-size:1em}nav[data-astro-cid-3ef6ksr2]{display:flex;align-items:baseline;justify-content:space-between}.internal-links[data-astro-cid-3ef6ksr2]{font-family:SaiyanSans,sans-serif;font-spacing:1em;font-size:2rem}nav[data-astro-cid-3ef6ksr2] .internal-links[data-astro-cid-3ef6ksr2]{margin-right:10em}nav[data-astro-cid-3ef6ksr2] a[data-astro-cid-3ef6ksr2]{padding:1em .5em;color:var(--black);border-bottom:4px solid transparent;text-decoration:none}nav[data-astro-cid-3ef6ksr2] a[data-astro-cid-3ef6ksr2]:hover{color:var(--accent);color:red;animation:shake .2s;animation-iteration-count:1;text-shadow:2px 4px rgba(0,0,0,.2);font-weight:bolder}@keyframes shake{0%{transform:translate(1px,1px) rotate(0)}10%{transform:translate(-1px,-2px) rotate(-5deg)}20%{transform:translate(-3px) rotate(5deg)}30%{transform:translate(3px,2px) rotate(0)}40%{transform:translate(1px,-1px) rotate(5deg)}50%{transform:translate(-1px,2px) rotate(-5deg)}60%{transform:translate(-3px,1px) rotate(0)}70%{transform:translate(3px,1px) rotate(-5deg)}80%{transform:translate(-1px,-1px) rotate(5deg)}90%{transform:translate(1px,2px) rotate(0)}to{transform:translate(1px,-2px) rotate(-5deg)}}nav[data-astro-cid-3ef6ksr2] a[data-astro-cid-3ef6ksr2].active{text-decoration:none;border-bottom-color:red}.social-links[data-astro-cid-3ef6ksr2],.social-links[data-astro-cid-3ef6ksr2] a[data-astro-cid-3ef6ksr2]{display:flex}@media (max-width: 720px){.social-links[data-astro-cid-3ef6ksr2]{display:none}}.aura-container[data-astro-cid-3ef6ksr2]{position:relative;display:inline-block;padding:60px}.aura-text[data-astro-cid-3ef6ksr2]{font-size:2.2rem;font-weight:700;font-family:SaiyanSans,sans-serif;color:red;position:relative;z-index:4;-webkit-text-stroke:1px black;letter-spacing:.1em}.aura-text[data-astro-cid-3ef6ksr2] .yellow[data-astro-cid-3ef6ksr2]{color:#ff0}.aura-text[data-astro-cid-3ef6ksr2] .organge[data-astro-cid-3ef6ksr2]{color:orange}.gif-aura[data-astro-cid-3ef6ksr2]{position:absolute;inset:0;background:url(/CFoa1-speed.gif) center/cover no-repeat;z-index:2;mix-blend-mode:screen;opacity:.8}.gif-bg-1[data-astro-cid-3ef6ksr2],.gif-bg-2[data-astro-cid-3ef6ksr2],.gif-bg-3[data-astro-cid-3ef6ksr2],.gif-bg-4[data-astro-cid-3ef6ksr2],.gif-bg-5[data-astro-cid-3ef6ksr2],.gif-bg-6[data-astro-cid-3ef6ksr2],.gif-bg-7[data-astro-cid-3ef6ksr2],.gif-bg-8[data-astro-cid-3ef6ksr2]{position:absolute;width:150px;height:150px;background:url(/CFoa1-speed.gif) center/contain no-repeat;z-index:4;mix-blend-mode:multiply;opacity:.9}.gif-bg-1[data-astro-cid-3ef6ksr2]{top:-5px;left:-5px;transform:rotate(-20deg)}.gif-bg-2[data-astro-cid-3ef6ksr2]{top:-5px;left:25%;transform:rotate(-5deg)}.gif-bg-3[data-astro-cid-3ef6ksr2]{top:-5px;left:50%;transform:rotate(5deg)}.gif-bg-4[data-astro-cid-3ef6ksr2]{top:-15px;right:-30px;transform:rotate(20deg)}.gif-bg-5[data-astro-cid-3ef6ksr2]{bottom:10px;left:-30px;transform:rotate(-160deg)}.gif-bg-6[data-astro-cid-3ef6ksr2]{bottom:10px;left:25%;transform:rotate(-160deg)}.gif-bg-7[data-astro-cid-3ef6ksr2]{bottom:10px;right:25%;transform:rotate(-160deg)}.gif-bg-8[data-astro-cid-3ef6ksr2]{bottom:10px;right:-30px;transform:rotate(160deg)}footer[data-astro-cid-sz7xmlte]{padding:2em 1em 6em;background:linear-gradient(var(--gray-gradient)) no-repeat;color:rgb(var(--gray));text-align:center}.social-links[data-astro-cid-sz7xmlte]{display:flex;justify-content:center;gap:1em;margin-top:1em}.social-links[data-astro-cid-sz7xmlte] a[data-astro-cid-sz7xmlte]{text-decoration:none;color:rgb(var(--gray))}.social-links[data-astro-cid-sz7xmlte] a[data-astro-cid-sz7xmlte]:hover{color:rgb(var(--gray-dark))}
a[data-astro-cid-eimmu3lg]{display:inline-block;text-decoration:none}a[data-astro-cid-eimmu3lg].active{font-weight:bolder;text-decoration:underline}
.scrollrectangle[data-astro-cid-bvzihdzo]{position:fixed;right:20px;width:20px;height:100px;background-color:#2c65d7;border-radius:10%;transition:top .3s ease-out;transform-origin:center center;animation:squeeze 1s infinite}@keyframes squeeze{0%{transform:scaleY(1)}50%{transform:scaleY(1.5)}to{transform:scaleY(1)}}main[data-astro-cid-bvzihdzo]{width:calc(100% - 2em);max-width:100%;margin:0}.hero-image[data-astro-cid-bvzihdzo]{width:100%}.hero-image[data-astro-cid-bvzihdzo] img[data-astro-cid-bvzihdzo]{display:block;margin:0 auto;border-radius:12px;box-shadow:var(--box-shadow)}.prose[data-astro-cid-bvzihdzo]{width:720px;max-width:calc(100% - 2em);margin:auto;padding:1em;color:rgb(var(--gray-dark))}.title[data-astro-cid-bvzihdzo]{margin-bottom:1em;padding:1em 0;text-align:center;line-height:1}.title[data-astro-cid-bvzihdzo] h1[data-astro-cid-bvzihdzo]{margin:0 0 .5em}.date[data-astro-cid-bvzihdzo]{margin-bottom:.5em;color:rgb(var(--gray))}.last-updated-on[data-astro-cid-bvzihdzo]{font-style:italic}
</style></head> <body data-astro-cid-bvzihdzo> <header data-astro-cid-3ef6ksr2> <nav data-astro-cid-3ef6ksr2> <div class="aura-container" data-astro-cid-3ef6ksr2> <div class="gif-bg-1" data-astro-cid-3ef6ksr2></div> <div class="gif-bg-2" data-astro-cid-3ef6ksr2></div> <div class="gif-bg-3" data-astro-cid-3ef6ksr2></div> <h2 class="aura-text" data-astro-cid-3ef6ksr2> <a href="/" data-astro-cid-3ef6ksr2> <span class="yellow" data-astro-cid-3ef6ksr2>Govind's</span> <img src="/dragonball.jpg" width="30px" height="30px" data-astro-cid-3ef6ksr2> <span data-astro-cid-3ef6ksr2>Blog</span> </a></h2> </div> <div class="internal-links" data-astro-cid-3ef6ksr2> <a href="/" data-astro-cid-3ef6ksr2="true" data-astro-cid-eimmu3lg> Home </a>  <a href="/blog" class="active" data-astro-cid-3ef6ksr2="true" data-astro-cid-eimmu3lg> Blog </a>  <a href="/ideas" data-astro-cid-3ef6ksr2="true" data-astro-cid-eimmu3lg> Steal My Ideas </a>  <a href="/editor" data-astro-cid-3ef6ksr2="true" data-astro-cid-eimmu3lg> Image Editor </a>  </div> <div class="social-links" data-astro-cid-3ef6ksr2> <a href="https://x.com/DeepknowledgeU" target="_blank" data-astro-cid-3ef6ksr2> <span class="sr-only" data-astro-cid-3ef6ksr2>Follow Astro on X</span> <svg viewBox="0 0 16 16" aria-hidden="true" width="32" height="32" astro-icon="social/twitter" data-astro-cid-3ef6ksr2><path fill="currentColor" d="M5.026 15c6.038 0 9.341-5.003 9.341-9.334 0-.14 0-.282-.006-.422A6.685 6.685 0 0 0 16 3.542a6.658 6.658 0 0 1-1.889.518 3.301 3.301 0 0 0 1.447-1.817 6.533 6.533 0 0 1-2.087.793A3.286 3.286 0 0 0 7.875 6.03a9.325 9.325 0 0 1-6.767-3.429 3.289 3.289 0 0 0 1.018 4.382A3.323 3.323 0 0 1 .64 6.575v.045a3.288 3.288 0 0 0 2.632 3.218 3.203 3.203 0 0 1-.865.115 3.23 3.23 0 0 1-.614-.057 3.283 3.283 0 0 0 3.067 2.277A6.588 6.588 0 0 1 .78 13.58a6.32 6.32 0 0 1-.78-.045A9.344 9.344 0 0 0 5.026 15z" data-astro-cid-3ef6ksr2></path></svg> </a> <a href="https://github.com/Gowind" target="_blank" data-astro-cid-3ef6ksr2> <span class="sr-only" data-astro-cid-3ef6ksr2>My Github</span> <svg viewBox="0 0 16 16" aria-hidden="true" width="32" height="32" astro-icon="social/github" data-astro-cid-3ef6ksr2><path fill="currentColor" d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.012 8.012 0 0 0 16 8c0-4.42-3.58-8-8-8z" data-astro-cid-3ef6ksr2></path></svg> </a> </div> </nav> </header>  <main data-astro-cid-bvzihdzo> <article data-astro-cid-bvzihdzo> <div class="scrollrectangle" data-astro-cid-bvzihdzo></div> <script type="module">const o=document.querySelector(".ball"),c=document.querySelector("header"),r=document.documentElement.scrollHeight-window.innerHeight,t=c?.offsetHeight;o.style.top=`${t+100}px`;window.addEventListener("scroll",()=>{const n=window.scrollY/r,l=window.innerHeight-100;let e=n*l;e=e>=t+100?e:t+100,o.style.top=`${e}px`});</script> <div class="hero-image" data-astro-cid-bvzihdzo> <img width="1020" height="510" src="/blog-placeholder-5.jpg" alt="" data-astro-cid-bvzihdzo> </div> <div class="prose" data-astro-cid-bvzihdzo> <div class="title" data-astro-cid-bvzihdzo> <div class="date" data-astro-cid-bvzihdzo> <time datetime="2024-01-20T00:00:00.000Z"> Jan 20, 2024 </time>  </div> <h1 data-astro-cid-bvzihdzo>From 500 secs to 3.5 - The 1brc Challenge</h1> <hr data-astro-cid-bvzihdzo> </div>  <p>All measurements run on an M2Pro Macbook 16” with 32GB RAM.</p>
<p>For those of you that aren’t aware of the <a href="">1brc</a> challenge, the goal is to parse 1 billion rows in a plain text file, each row mapping a city to the temperature observed on a particular day and computing the min,max,average and total temperatures of each city.
The output has to be alphabetically sorted based on the name of the city.</p>
<p>The title is a little clickbait-y, because I knew that my initial solution was going to be slow, but yet I still ran it for the sake of it.</p>
<h2 id="if-it-works-it-aint-stupid">If it works, it ain’t stupid</h2>
<p>My first solution was to write a dumb shell script. Too lazy, I asked chatGPT to generate an <code>awk</code> script for me to do it and then I ran it on my local machine.</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="bash"><code><span class="line"><span style="color:#B392F0">$</span><span style="color:#9ECBFF"> cat</span><span style="color:#9ECBFF"> average.sh</span></span>
<span class="line"><span style="color:#6A737D">#!/bin/bash</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D"># Input file path</span></span>
<span class="line"><span style="color:#E1E4E8">input_file</span><span style="color:#F97583">=</span><span style="color:#9ECBFF">"measurements.txt"</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D"># Check if the file exists</span></span>
<span class="line"><span style="color:#F97583">if</span><span style="color:#E1E4E8"> [ </span><span style="color:#F97583">!</span><span style="color:#F97583"> -f</span><span style="color:#9ECBFF"> "</span><span style="color:#E1E4E8">$input_file</span><span style="color:#9ECBFF">"</span><span style="color:#E1E4E8"> ]; </span><span style="color:#F97583">then</span></span>
<span class="line"><span style="color:#79B8FF">    echo</span><span style="color:#9ECBFF"> "Error: File not found: </span><span style="color:#E1E4E8">$input_file</span><span style="color:#9ECBFF">"</span></span>
<span class="line"><span style="color:#79B8FF">    exit</span><span style="color:#79B8FF"> 1</span></span>
<span class="line"><span style="color:#F97583">fi</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D"># Use awk to calculate average temperature per city</span></span>
<span class="line"><span style="color:#B392F0">awk</span><span style="color:#79B8FF"> -F</span><span style="color:#9ECBFF">';'</span><span style="color:#9ECBFF"> '{</span></span>
<span class="line"><span style="color:#9ECBFF">    city = $1</span></span>
<span class="line"><span style="color:#9ECBFF">    temperature = $2</span></span>
<span class="line"><span style="color:#9ECBFF">    sum[city] += temperature</span></span>
<span class="line"><span style="color:#9ECBFF">    count[city]++</span></span>
<span class="line"><span style="color:#9ECBFF">}</span></span>
<span class="line"><span style="color:#9ECBFF">END {</span></span>
<span class="line"><span style="color:#9ECBFF">    for (city in sum) {</span></span>
<span class="line"><span style="color:#9ECBFF">        average = sum[city] / count[city]</span></span>
<span class="line"><span style="color:#9ECBFF">        printf "City: %s, Average Temperature: %.2f\n", city, average</span></span>
<span class="line"><span style="color:#9ECBFF">    }</span></span>
<span class="line"><span style="color:#9ECBFF">}'</span><span style="color:#9ECBFF"> "</span><span style="color:#E1E4E8">$input_file</span><span style="color:#9ECBFF">"</span></span></code></pre>
<p>The result ? 487 secs for a single run.</p>
<p>That shell scripts are slow is a known thing. What next ? I didn’t want to spend too much time on it, so I wrote a similar script in Javascript with a single thread (I lost the code for it, but it isn’t too hard to write). The script didn’t do much faster, running at about 460ish seconds (even V8 can only do so much I guess).</p>
<h2 id="going-brrr">Going brrr</h2>
<p>How do I make this faster ? This problem is trivially parallelizable. Since each line is a separate entry, we can split the giant file to be worked on by different <code>worker</code> threads and then merge the results of all the <code>worker</code> threads together in the main thread. The tricky bit is how do we split the file ?</p>
<p>We can use the <a href="https://linux.die.net/man/2/stat">stat</a> api to find the size of a file without having to read the entire file.
Once we know the size of the file, we can split it into chunks , where chunk size = <code>sizeof(file)/num_threads</code>. Each thread will read the lines present between bytes : [ <code>thread_index * chunk_size</code> … <code>(thread_index + 1) * chunk_size</code>] and in a thread local HashMap, map each city => number of times we saw an entry for the city , the min , max temperatures and the total sum of all the temperatures we have seen.
Once the threads sum up their chunk of the file, we then merge the results of these local HashMap into a global HashMap to calculate each city’s min, max and avg. temperatures.</p>
<p>The file is made of lines like <code>Vienna;19.1\nPhoenix;16.1\n</code>. The <code>\n</code> at the end and the <code>V</code> at the beginning might not align exactly for all the chunks of our threads. What do we do in that case ?</p>
<p>Before a thread begins to process a chunk, we need to adjust its start and end offsets such that the start offset starts at a character right after a <code>\n</code> (thus a new entry) and adjust the end character so that it aligns with a <code>\n</code> .</p>
<p>Here is how I did it in my code</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="js"><code><span class="line"></span>
<span class="line"><span style="color:#F97583">if</span><span style="color:#E1E4E8">(startOffset </span><span style="color:#F97583">></span><span style="color:#79B8FF"> 0</span><span style="color:#E1E4E8">) {</span></span>
<span class="line"><span style="color:#F97583"> let</span><span style="color:#E1E4E8"> buf </span><span style="color:#F97583">=</span><span style="color:#F97583"> await</span><span style="color:#B392F0"> readHundred</span><span style="color:#E1E4E8">(handle, startOffset</span><span style="color:#F97583">-</span><span style="color:#79B8FF">1</span><span style="color:#E1E4E8">);</span></span>
<span class="line"><span style="color:#F97583"> if</span><span style="color:#E1E4E8">(buf[</span><span style="color:#79B8FF">0</span><span style="color:#E1E4E8">] </span><span style="color:#F97583">==</span><span style="color:#9ECBFF"> '</span><span style="color:#79B8FF">\n</span><span style="color:#9ECBFF">'</span><span style="color:#E1E4E8">) {</span></span>
<span class="line"><span style="color:#E1E4E8"> } </span><span style="color:#F97583">else</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#F97583">    let</span><span style="color:#E1E4E8"> nextPos </span><span style="color:#F97583">=</span><span style="color:#B392F0"> nextNewLine</span><span style="color:#E1E4E8">(buf, </span><span style="color:#9ECBFF">"start"</span><span style="color:#E1E4E8">);</span></span>
<span class="line"><span style="color:#E1E4E8">    startOffset </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> nextPos </span><span style="color:#F97583">+</span><span style="color:#E1E4E8"> startOffset;</span></span>
<span class="line"><span style="color:#E1E4E8"> }</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span>
<span class="line"><span style="color:#F97583">async</span><span style="color:#F97583"> function</span><span style="color:#B392F0"> readHundred</span><span style="color:#E1E4E8">(</span><span style="color:#FFAB70">handle</span><span style="color:#E1E4E8">, </span><span style="color:#FFAB70">pos</span><span style="color:#E1E4E8">) {</span></span>
<span class="line"><span style="color:#F97583">  let</span><span style="color:#E1E4E8"> b </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> Buffer.</span><span style="color:#B392F0">alloc</span><span style="color:#E1E4E8">(</span><span style="color:#79B8FF">100</span><span style="color:#E1E4E8">);</span></span>
<span class="line"><span style="color:#F97583">  let</span><span style="color:#E1E4E8"> results </span><span style="color:#F97583">=</span><span style="color:#F97583"> await</span><span style="color:#E1E4E8"> handle.</span><span style="color:#B392F0">read</span><span style="color:#E1E4E8">(b, </span><span style="color:#79B8FF">0</span><span style="color:#E1E4E8">, </span><span style="color:#79B8FF">100</span><span style="color:#E1E4E8">, pos);</span></span>
<span class="line"><span style="color:#F97583">  return</span><span style="color:#E1E4E8"> results.buffer.</span><span style="color:#B392F0">slice</span><span style="color:#E1E4E8">(</span><span style="color:#79B8FF">0</span><span style="color:#E1E4E8">, results.bytesRead</span><span style="color:#F97583">-</span><span style="color:#79B8FF">1</span><span style="color:#E1E4E8">).</span><span style="color:#B392F0">toString</span><span style="color:#E1E4E8">();</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span></code></pre>
<p>I took the liberty that each line is less than a 100 chars long, so that we can always find the <code>\n</code> by just reading 100 chars past the start offset.</p>
<p>Similarly for the end offset</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="js"><code><span class="line"><span style="color:#F97583">if</span><span style="color:#E1E4E8">(endOffset </span><span style="color:#F97583">&#x3C;</span><span style="color:#E1E4E8"> totalSize) {</span></span>
<span class="line"><span style="color:#F97583">  let</span><span style="color:#E1E4E8"> buf </span><span style="color:#F97583">=</span><span style="color:#F97583"> await</span><span style="color:#B392F0"> readHundred</span><span style="color:#E1E4E8">(handle, endOffset);</span></span>
<span class="line"><span style="color:#F97583">  if</span><span style="color:#E1E4E8">(buf[</span><span style="color:#79B8FF">0</span><span style="color:#E1E4E8">] </span><span style="color:#F97583">==</span><span style="color:#9ECBFF"> "</span><span style="color:#79B8FF">\n</span><span style="color:#9ECBFF">"</span><span style="color:#F97583"> ||</span><span style="color:#E1E4E8"> buf[</span><span style="color:#79B8FF">0</span><span style="color:#E1E4E8">] </span><span style="color:#F97583">==</span><span style="color:#9ECBFF"> "</span><span style="color:#79B8FF">\x00</span><span style="color:#9ECBFF">"</span><span style="color:#E1E4E8">) {</span></span>
<span class="line"><span style="color:#E1E4E8">  } </span><span style="color:#F97583">else</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#F97583">    let</span><span style="color:#E1E4E8"> nn </span><span style="color:#F97583">=</span><span style="color:#B392F0"> nextNewLine</span><span style="color:#E1E4E8">(buf, </span><span style="color:#9ECBFF">"end"</span><span style="color:#E1E4E8">);</span></span>
<span class="line"><span style="color:#E1E4E8">    endOffset </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> nn </span><span style="color:#F97583">+</span><span style="color:#E1E4E8"> endOffset;</span></span>
<span class="line"><span style="color:#E1E4E8">  }</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">function</span><span style="color:#B392F0"> nextNewLine</span><span style="color:#E1E4E8">(</span><span style="color:#FFAB70">buffer</span><span style="color:#E1E4E8">, </span><span style="color:#FFAB70">ev</span><span style="color:#E1E4E8">) {</span></span>
<span class="line"><span style="color:#F97583">  let</span><span style="color:#E1E4E8"> x </span><span style="color:#F97583">=</span><span style="color:#79B8FF"> 0</span><span style="color:#E1E4E8">;</span></span>
<span class="line"><span style="color:#F97583">  let</span><span style="color:#E1E4E8"> j </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> buffer.</span><span style="color:#B392F0">toString</span><span style="color:#E1E4E8">();</span></span>
<span class="line"><span style="color:#F97583">  while</span><span style="color:#E1E4E8">(x </span><span style="color:#F97583">&#x3C;</span><span style="color:#E1E4E8"> j.</span><span style="color:#79B8FF">length</span><span style="color:#E1E4E8">) {</span></span>
<span class="line"><span style="color:#F97583">    if</span><span style="color:#E1E4E8">(j[x] </span><span style="color:#F97583">==</span><span style="color:#9ECBFF"> '</span><span style="color:#79B8FF">\n</span><span style="color:#9ECBFF">'</span><span style="color:#E1E4E8">) {</span></span>
<span class="line"><span style="color:#F97583">      return</span><span style="color:#E1E4E8"> x;</span></span>
<span class="line"><span style="color:#E1E4E8">    }</span></span>
<span class="line"><span style="color:#E1E4E8">    x </span><span style="color:#F97583">+=</span><span style="color:#79B8FF"> 1</span><span style="color:#E1E4E8">;</span></span>
<span class="line"><span style="color:#E1E4E8">  }</span></span>
<span class="line"><span style="color:#F97583">  return</span><span style="color:#E1E4E8"> x;</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span></code></pre>
<p>Once the thread finds the start and the end offsets for each chunk,it creates a stream between the 2 offsets and iterates through them line by line :</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="js"><code><span class="line"><span style="color:#F97583">const</span><span style="color:#79B8FF"> readStream</span><span style="color:#F97583"> =</span><span style="color:#F97583"> await</span><span style="color:#E1E4E8"> handle.</span><span style="color:#B392F0">createReadStream</span><span style="color:#E1E4E8">({start: startOffset, end: endOffset});</span></span>
<span class="line"><span style="color:#F97583">const</span><span style="color:#79B8FF"> rl</span><span style="color:#F97583"> =</span><span style="color:#E1E4E8"> readline.</span><span style="color:#B392F0">createInterface</span><span style="color:#E1E4E8">({</span></span>
<span class="line"><span style="color:#E1E4E8">    input: readStream,</span></span>
<span class="line"><span style="color:#E1E4E8">    crlfDelay: </span><span style="color:#79B8FF">Infinity</span><span style="color:#6A737D"> // To handle Windows line endings</span></span>
<span class="line"><span style="color:#E1E4E8">  });</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8">rl.</span><span style="color:#B392F0">on</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">'line'</span><span style="color:#E1E4E8">, (</span><span style="color:#FFAB70">row</span><span style="color:#E1E4E8">) </span><span style="color:#F97583">=></span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#B392F0">  processRow</span><span style="color:#E1E4E8">(row);</span></span>
<span class="line"><span style="color:#E1E4E8">});</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8">rl.</span><span style="color:#B392F0">on</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">'close'</span><span style="color:#E1E4E8">, () </span><span style="color:#F97583">=></span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#B392F0"> wrapUp</span><span style="color:#E1E4E8">();</span></span>
<span class="line"><span style="color:#E1E4E8">});</span></span></code></pre>
<p>You can find this version of code in <a href="https://github.com/GoWind/1brc/commit/7a64018720365608c5ba8fcb080c63f61cb54f2e">this</a> commit. Running this code with 12 threads (8 E cores and 4 P cores on my M2 Pro machine), I got it run at about 48 secs on avg.</p>
<p>Readline is a rather slow way to iterate over a chunk of data because it reads a chunk of text line by line. When looping over a ReadStream, we can loop over Text Chunks rather than lines and this might be faster (you can find this version of my solution in <a href="https://github.com/GoWind/1brc/commit/3d3be7fd1c51d9304b3cce34bde4d29818db565b">this</a>commit)</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="diff"><code><span class="line"><span style="color:#FDAEB7"><span style="user-select: none;">-</span>const rl = readline.createInterface({</span></span>
<span class="line"><span style="color:#FDAEB7"><span style="user-select: none;">-</span>    input: readStream,</span></span>
<span class="line"><span style="color:#FDAEB7"><span style="user-select: none;">-</span>    crlfDelay: Infinity // To handle Windows line endings</span></span>
<span class="line"><span style="color:#FDAEB7"><span style="user-select: none;">-</span>  });</span></span>
<span class="line"></span>
<span class="line"><span style="color:#FDAEB7"><span style="user-select: none;">-</span>rl.on('line', (row) => {</span></span>
<span class="line"><span style="color:#FDAEB7"><span style="user-select: none;">-</span>  processRow(row);</span></span>
<span class="line"><span style="color:#FDAEB7"><span style="user-select: none;">-</span>});</span></span>
<span class="line"><span style="color:#85E89D"><span style="user-select: none;">+</span>for await (const chunk of readStream) {</span></span>
<span class="line"><span style="color:#85E89D"><span style="user-select: none;">+</span>    let res = await handler(chunk);</span></span>
<span class="line"><span style="color:#85E89D"><span style="user-select: none;">+</span>    if(res == false) {</span></span>
<span class="line"><span style="color:#85E89D"><span style="user-select: none;">+</span>      break;</span></span>
<span class="line"><span style="color:#85E89D"><span style="user-select: none;">+</span>    }</span></span>
<span class="line"><span style="color:#85E89D"><span style="user-select: none;">+</span>}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#FDAEB7"><span style="user-select: none;">-</span>rl.on('close', () => {</span></span>
<span class="line"><span style="color:#FDAEB7"><span style="user-select: none;">-</span> wrapUp();</span></span>
<span class="line"><span style="color:#FDAEB7"><span style="user-select: none;">-</span>});</span></span>
<span class="line"><span style="color:#85E89D"><span style="user-select: none;">+</span>async function handler(chunk) {</span></span>
<span class="line"><span style="color:#85E89D"><span style="user-select: none;">+</span>  let updatedChunk = globalBuffer.concat(chunk);</span></span>
<span class="line"><span style="color:#85E89D"><span style="user-select: none;">+</span>  let rows = updatedChunk.split("\n");</span></span>
<span class="line"><span style="color:#85E89D"><span style="user-select: none;">+</span>  if(rows.length) {</span></span>
<span class="line"><span style="color:#85E89D"><span style="user-select: none;">+</span>     if(rows[rows.length-1] == "") {</span></span>
<span class="line"><span style="color:#85E89D"><span style="user-select: none;">+</span>        globalBuffer = "";</span></span>
<span class="line"><span style="color:#85E89D"><span style="user-select: none;">+</span>        processRows(rows.slice(0, -1));</span></span>
<span class="line"><span style="color:#85E89D"><span style="user-select: none;">+</span>     } else {</span></span>
<span class="line"><span style="color:#85E89D"><span style="user-select: none;">+</span>       globalBuffer = rows[rows.length-1];</span></span>
<span class="line"><span style="color:#85E89D"><span style="user-select: none;">+</span>       processRows(rows.slice(0, -1));</span></span>
<span class="line"><span style="color:#85E89D"><span style="user-select: none;">+</span>     }</span></span>
<span class="line"><span style="color:#85E89D"><span style="user-select: none;">+</span>  }</span></span>
<span class="line"><span style="color:#85E89D"><span style="user-select: none;">+</span>}</span></span>
<span class="line"><span style="color:#85E89D"><span style="user-select: none;">+</span>wrapUp();</span></span></code></pre>
<p>Using chunking as opposed to ReadLine improved the solution by roughly 20%. I was able to get the solution to run on an avg. of 40secs.</p>
<h3 id="faster">Faster ?</h3>
<p>I was running out of ideas to improve the speed in JS, so time to bring out the BFG 9000: Zig.
As a statically-typed, compiled language, we should be able to (hopefully) run much faster in Zig.
I used the same approach to build a multi-threaded Zig program, using the same offset calculation with threads swapping the JS for Zig.</p>
<h4 id="timing">Timing ?</h4>
<p>6.7 secs !</p>
<p>I initially got a shock, because I was doing a Debug build and the Debug build ran with an average of 56secs. For a few moments, I was questioning my life decisions and existence in a world where JS was faster than Zig. Running <code>zig build</code> with the <code>Doptimize=ReleaseFast</code> flag turned on optimizations that literally 8xed the speed of my <a href="https://github.com/GoWind/1brc/commit/7760c6dda6930ff4464cc2cc049bf35988960441">solution</a></p>
<p>I was happy, but by this point, the Java peeps had made the Java solution complete in under 6 secs. Can I beat that ?</p>
<h3 id="moaaar-power">Moaaar power</h3>
<p>I wanted to do a couple of tweaks before calling it quits. These tweaks were stuff I found in Danny Van Kooten’s <a href="https://github.com/dannyvankooten/1brc/blob/main/analyze.c">solution</a> in C.</p>
<ol>
<li>Use <code>mmap</code> to map the file into the virtual memory, instead of trying to read chunks of the file in each thread to find the start and the end offsets</li>
<li>A faster hashMap implementation</li>
<li>not trying to parse the temperatures as floats</li>
</ol>
<p><a href="https://man7.org/linux/man-pages/man2/mmap.2.html">mmap</a> takes the contents of a file and maps it into the virtual memory of a process. This makes reading the file as simple as updating a pointer , while the Filesystem + OS takes care of swapping in and out the parts of the files currently being read. We are not updating the mapping/file, only reading it , so <code>mmap</code>ing the file turned out to be a simple choice</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="diff"><code><span class="line"><span style="color:#FDAEB7"><span style="user-select: none;">-</span>    const file = try std.fs.openFileAbsoluteZ(filepath, .{});</span></span>
<span class="line"><span style="color:#FDAEB7"><span style="user-select: none;">-</span>    defer file.close();</span></span>
<span class="line"><span style="color:#FDAEB7"><span style="user-select: none;">-</span>    const stat = try file.stat();</span></span>
<span class="line"><span style="color:#FDAEB7"><span style="user-select: none;">-</span>    std.debug.print("file size is {}\n", .{stat.size});</span></span>
<span class="line"><span style="color:#85E89D"><span style="user-select: none;">+</span>    const fd = try std.os.open(filepath, std.os.O.RDONLY, 0);</span></span>
<span class="line"><span style="color:#85E89D"><span style="user-select: none;">+</span>    defer std.os.close(fd);</span></span>
<span class="line"><span style="color:#85E89D"><span style="user-select: none;">+</span>    const stat = try std.os.fstat(fd);</span></span>
<span class="line"><span style="color:#85E89D"><span style="user-select: none;">+</span>    const mapping = try std.os.mmap(null, @as(u64, @intCast(stat.size)), std.os.PROT.READ, std.os.MAP.PRIVATE, fd, 0);</span></span>
<span class="line"><span style="color:#85E89D"><span style="user-select: none;">+</span>    defer std.os.munmap(mapping);</span></span>
<span class="line"></span></code></pre>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="diff"><code><span class="line"><span style="color:#B392F0;font-weight:bold">@@ -43,146 +44,60 @@</span><span style="color:#E1E4E8"> fn calculate(</span></span>
<span class="line"><span style="color:#E1E4E8">     idx: usize,</span></span>
<span class="line"><span style="color:#E1E4E8">     workerSize: u64,</span></span>
<span class="line"><span style="color:#E1E4E8">     allocator: std.mem.Allocator,</span></span>
<span class="line"><span style="color:#FDAEB7"><span style="user-select: none;">-</span>    filepath: [*:0]u8,</span></span>
<span class="line"><span style="color:#85E89D"><span style="user-select: none;">+</span>    file: []u8,</span></span>
<span class="line"><span style="color:#E1E4E8"> ) !void {</span></span>
<span class="line"><span style="color:#FDAEB7"><span style="user-select: none;">-</span>    var buffer = [_]u8{'a'} ** 80000;</span></span>
<span class="line"><span style="color:#FDAEB7"><span style="user-select: none;">-</span>    const waterMarkSize: usize = 80000;</span></span>
<span class="line"><span style="color:#FDAEB7"><span style="user-select: none;">-</span>    const slice = buffer[0..100];</span></span>
<span class="line"><span style="color:#FDAEB7"><span style="user-select: none;">-</span>    const View = struct { slice: []u8, len: usize };</span></span>
<span class="line"><span style="color:#FDAEB7"><span style="user-select: none;">-</span>    const file = try std.fs.openFileAbsoluteZ(filepath, .{});</span></span>
<span class="line"><span style="color:#FDAEB7"><span style="user-select: none;">-</span>    const stat = try file.stat();</span></span>
<span class="line"><span style="color:#FDAEB7"><span style="user-select: none;">-</span>    defer file.close();</span></span>
<span class="line"><span style="color:#85E89D"><span style="user-select: none;">+</span>    const finalEndOffset = file.len - 1;</span></span>
<span class="line"><span style="color:#E1E4E8">     var startOffset = idx * workerSize;</span></span>
<span class="line"><span style="color:#E1E4E8">     var endOffset = (idx + 1) * workerSize - 1;</span></span>
<span class="line"><span style="color:#E1E4E8">     if (startOffset > 0) {</span></span>
<span class="line"><span style="color:#E1E4E8">         const prev = startOffset - 1;</span></span>
<span class="line"><span style="color:#FDAEB7"><span style="user-select: none;">-</span>        try file.seekTo(prev);</span></span>
<span class="line"><span style="color:#FDAEB7"><span style="user-select: none;">-</span>        const read = try file.readAll(slice);</span></span>
<span class="line"><span style="color:#FDAEB7"><span style="user-select: none;">-</span>        if (read == 0) {</span></span>
<span class="line"><span style="color:#FDAEB7"><span style="user-select: none;">-</span>            @panic("failed to read from starting offset");</span></span>
<span class="line"><span style="color:#FDAEB7"><span style="user-select: none;">-</span>        }</span></span>
<span class="line"><span style="color:#FDAEB7"><span style="user-select: none;">-</span>        if (buffer[0] != '\n') {</span></span>
<span class="line"><span style="color:#FDAEB7"><span style="user-select: none;">-</span>            var i: usize = 1;</span></span>
<span class="line"><span style="color:#FDAEB7"><span style="user-select: none;">-</span>            while (i &#x3C; read) : (i += 1) {</span></span>
<span class="line"><span style="color:#FDAEB7"><span style="user-select: none;">-</span>                if (buffer[i] == '\n') {</span></span>
<span class="line"><span style="color:#FDAEB7"><span style="user-select: none;">-</span>                    startOffset += i;</span></span>
<span class="line"><span style="color:#FDAEB7"><span style="user-select: none;">-</span>                    break;</span></span>
<span class="line"><span style="color:#FDAEB7"><span style="user-select: none;">-</span>                }</span></span>
<span class="line"><span style="color:#85E89D"><span style="user-select: none;">+</span>        if (file[prev] != '\n') {</span></span>
<span class="line"><span style="color:#85E89D"><span style="user-select: none;">+</span>            while (file[startOffset] != '\n') {</span></span>
<span class="line"><span style="color:#85E89D"><span style="user-select: none;">+</span>                startOffset += 1;</span></span>
<span class="line"><span style="color:#E1E4E8">             }</span></span>
<span class="line"><span style="color:#FDAEB7"><span style="user-select: none;">-</span>        }</span></span>
<span class="line"></span></code></pre>
<p>I didn’t record the timings for [this] change alone, but my measurements varied anywhere from ~5.5-9secs (probably depending on filesystem caches in memory being cold/warm)</p>
<p>The next trick I attempted to use was to parse each temperature as an <code>i32</code> and not as a <code>f32</code>. Float parsing is tricky, and slower than parsing integers. Since each temperature entry in the challenge has only one digit after the decimal point, we can parse <code>16.1</code> as <code>161</code> and divide the final result only by <code>10</code>, thus saving a lot of time spent parsing</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="diff"><code><span class="line"><span style="color:#FDAEB7"><span style="user-select: none;">-</span>pub const Record = struct { min: f32 = 0, max: f32 = 0, total: f32 = 0, count: u32 = 0 };</span></span>
<span class="line"><span style="color:#85E89D"><span style="user-select: none;">+</span>const SliceList = std.ArrayList([]const u8);</span></span>
<span class="line"><span style="color:#85E89D"><span style="user-select: none;">+</span>const writer = std.io.getStdOut().writer();</span></span>
<span class="line"><span style="color:#85E89D"><span style="user-select: none;">+</span>pub const Record = struct { min: i32 = 0, max: i32 = 0, total: i32 = 0, count: u32 = 0 };</span></span>
<span class="line"><span style="color:#E1E4E8">...</span></span>
<span class="line"><span style="color:#FDAEB7"><span style="user-select: none;">-</span>            const temp = try std.fmt.parseFloat(f32, num);</span></span>
<span class="line"><span style="color:#85E89D"><span style="user-select: none;">+</span>            const temp = parsei32(num);</span></span></code></pre>
<p>(Again, I did not record the timings for this change <a href="https://github.com/GoWind/1brc/commit/23fafbfebbb82bafcd9433e1230f89a6c6cdf52a">this</a> change alone)</p>
<p>The last trick I wanted to try was using a custom Hash function / HashMap for tracking city -> temperature stats. From profiling my application with flamegraphs, it was clear that most of the time was spent in looking up a city’s existing entry in the threadlocal HashMap. Since our keys are strings, we can use a simple hash function to hash the city names. A simple function that is easy to compute is <a href="https://t.co/C2ZfSSiYSW">djb2</a>. I decided to use this as my hash fn</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="ts"><code><span class="line"><span style="color:#E1E4E8">fn </span><span style="color:#B392F0">hashSlice</span><span style="color:#E1E4E8">(data: []u8, totalSize: usize) usize {</span></span>
<span class="line"><span style="color:#F97583">    var</span><span style="color:#E1E4E8"> k</span><span style="color:#F97583">:</span><span style="color:#B392F0"> usize</span><span style="color:#F97583"> =</span><span style="color:#79B8FF"> 0</span><span style="color:#E1E4E8">;</span></span>
<span class="line"><span style="color:#F97583">    var</span><span style="color:#E1E4E8"> hash</span><span style="color:#F97583">:</span><span style="color:#B392F0"> usize</span><span style="color:#F97583"> =</span><span style="color:#79B8FF"> 0</span><span style="color:#E1E4E8">;</span></span>
<span class="line"><span style="color:#F97583">    while</span><span style="color:#E1E4E8"> (k </span><span style="color:#F97583">&#x3C;</span><span style="color:#E1E4E8"> data.len) : (k </span><span style="color:#F97583">+=</span><span style="color:#79B8FF"> 1</span><span style="color:#E1E4E8">) {</span></span>
<span class="line"><span style="color:#E1E4E8">        hash </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> (hash </span><span style="color:#F97583">*</span><span style="color:#79B8FF"> 31</span><span style="color:#F97583"> +</span><span style="color:#E1E4E8"> data[k]) </span><span style="color:#F97583">&#x26;</span><span style="color:#E1E4E8"> (totalSize </span><span style="color:#F97583">-</span><span style="color:#79B8FF"> 1</span><span style="color:#E1E4E8">);</span></span>
<span class="line"><span style="color:#E1E4E8">    }</span></span>
<span class="line"><span style="color:#F97583">    return</span><span style="color:#E1E4E8"> hash;</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span></code></pre>
<p>As for a HashMap, is there a faster way ? We know that there aren’t a lot of cities in the entry, so we probably can get away with replacing the thread local HashMap with an array instead (actually 2 arrays)</p>
<ol>
<li>We create a threadlocal array with 2^16 entries and fill each of them with a <code>0</code>.</li>
<li>We create another array: <code>entries</code>, with index <code>i</code> starting at 0. Each new string is provided a new index in this array. The values of entries are all set to a sentinel value.</li>
<li>We hash each string and then perform a module of that hash with (2^16-1) thus getting a number N between [0, 2^16-1].</li>
<li>We then start at array[N] and proceed with N = (N+ 1) % 2^16-1 , till array[N] == Sentinel Value or array[N] == N.</li>
<li>if entries[N] is a Sentinel Value, it means we have not encountered string S yet. We create a Record for this city at <code>entries[N]</code> and set Array[N] = N</li>
<li>Else, it means we already have a valid entry for the city S. We then simply update the count and the min,max and average of the City at entries[N]</li>
</ol>
<p>It is probably much simpler to understand the code:</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="diff"><code><span class="line"><span style="color:#85E89D"><span style="user-select: none;">+</span>    var hashList = try NumList.initCapacity(allocator, maxSize);</span></span>
<span class="line"><span style="color:#85E89D"><span style="user-select: none;">+</span>    var indexList = try NumList.initCapacity(allocator, maxSize);</span></span>
<span class="line"><span style="color:#85E89D"><span style="user-select: none;">+</span>    hashList.appendNTimesAssumeCapacity(0, maxSize);</span></span>
<span class="line"><span style="color:#85E89D"><span style="user-select: none;">+</span>    indexList.appendNTimesAssumeCapacity(1 &#x3C;&#x3C; 16, maxSize);</span></span>
<span class="line"><span style="color:#E1E4E8">// 1 &#x3C;&#x3C; 16 is the sentinel value</span></span>
<span class="line"></span>
<span class="line"><span style="color:#FDAEB7"><span style="user-select: none;">-</span></span></span>
<span class="line"><span style="color:#FDAEB7"><span style="user-select: none;">-</span>            const maybeEntry = threadMap[idx].getEntry(city);</span></span>
<span class="line"><span style="color:#FDAEB7"><span style="user-select: none;">-</span>            if (maybeEntry) |entry| {</span></span>
<span class="line"><span style="color:#FDAEB7"><span style="user-select: none;">-</span>                entry.value_ptr.*.count += 1;</span></span>
<span class="line"><span style="color:#FDAEB7"><span style="user-select: none;">-</span>                entry.value_ptr.*.total += temp;</span></span>
<span class="line"><span style="color:#FDAEB7"><span style="user-select: none;">-</span>                entry.value_ptr.*.max = @max(entry.value_ptr.*.max, temp);</span></span>
<span class="line"><span style="color:#FDAEB7"><span style="user-select: none;">-</span>                entry.value_ptr.*.min = @min(entry.value_ptr.*.min, temp);</span></span>
<span class="line"><span style="color:#85E89D"><span style="user-select: none;">+</span>            var hashVal = hashSlice(city, maxSize);</span></span>
<span class="line"><span style="color:#85E89D"><span style="user-select: none;">+</span>            while (hashList.items[hashVal] != hashVal and hashList.items[hashVal] != 0) {</span></span>
<span class="line"><span style="color:#85E89D"><span style="user-select: none;">+</span>                hashVal = (hashVal + 1) &#x26; (maxSize - 1);</span></span>
<span class="line"><span style="color:#85E89D"><span style="user-select: none;">+</span>            }</span></span>
<span class="line"><span style="color:#85E89D"><span style="user-select: none;">+</span>            const entryIdx = indexList.items[hashVal];</span></span>
<span class="line"><span style="color:#85E89D"><span style="user-select: none;">+</span>            if (entryIdx == 1 &#x3C;&#x3C; 16) {</span></span>
<span class="line"><span style="color:#85E89D"><span style="user-select: none;">+</span>                const cityNameForRec = try allocator.alloc(u8, city.len);</span></span>
<span class="line"><span style="color:#85E89D"><span style="user-select: none;">+</span>                @memcpy(cityNameForRec, city);</span></span>
<span class="line"><span style="color:#85E89D"><span style="user-select: none;">+</span>                const rec = Record{ .city = cityNameForRec, .count = 1, .min = temp, .max = tem</span></span>
<span class="line"><span style="color:#E1E4E8">p, .total = temp };</span></span>
<span class="line"><span style="color:#85E89D"><span style="user-select: none;">+</span>                try threadMap[idx].append(rec);</span></span>
<span class="line"><span style="color:#85E89D"><span style="user-select: none;">+</span>                indexList.items[hashVal] = threadMap[idx].items.len - 1;</span></span>
<span class="line"><span style="color:#85E89D"><span style="user-select: none;">+</span>                hashList.items[hashVal] = hashVal;</span></span>
<span class="line"><span style="color:#E1E4E8">             } else {</span></span>
<span class="line"><span style="color:#FDAEB7"><span style="user-select: none;">-</span>                const rec = Record{ .count = 1, .min = temp, .max = temp, .total = temp };</span></span>
<span class="line"><span style="color:#FDAEB7"><span style="user-select: none;">-</span>                const k = try allocator.alloc(u8, city.len);</span></span>
<span class="line"><span style="color:#FDAEB7"><span style="user-select: none;">-</span>                @memcpy(k, city);</span></span>
<span class="line"><span style="color:#FDAEB7"><span style="user-select: none;">-</span>                try threadMap[idx].put(k, rec);</span></span>
<span class="line"><span style="color:#85E89D"><span style="user-select: none;">+</span>                threadMap[idx].items[entryIdx].count += 1;</span></span>
<span class="line"><span style="color:#85E89D"><span style="user-select: none;">+</span>                threadMap[idx].items[entryIdx].total += temp;</span></span>
<span class="line"><span style="color:#85E89D"><span style="user-select: none;">+</span>                threadMap[idx].items[entryIdx].max = @max(threadMap[idx].items[entryIdx].max, t</span></span>
<span class="line"><span style="color:#E1E4E8">emp);</span></span>
<span class="line"><span style="color:#85E89D"><span style="user-select: none;">+</span>                threadMap[idx].items[entryIdx].min = @min(threadMap[idx].items[entryIdx].min, t</span></span>
<span class="line"><span style="color:#E1E4E8">emp);</span></span>
<span class="line"><span style="color:#E1E4E8">             }</span></span></code></pre>
<p>We replaced the zig HashMap with our custom one. So how did the end result go ?</p>
<h4 id="answer-faaast">Answer: Faaast !</h4>
<p>The <a href="https://github.com/GoWind/1brc/commit/dfc37a92b5fcb835dc994e48ef54eab060fd03bb?diff=unified&#x26;w=1">updated</a>solution hit ~3.5 secs on the average. This was almost 2x faster than our previous solution ! I was elated that such simple optimizations could make such a big difference.</p>
<p>I wanted to proceed with more optimizations to make the solution go even faster, but unfortunately I no longer had the time to pursue the project , and having hit the deadline I set for myself, was happy to have come so far. Also given that my daily driver is a Mac, it was very hard to generate flamegraphs for Zig programs and trying to optimize programs without them is like trying to navigate a race course blind. In the end, I decided to wrap up the experiments and call it a day</p>
<h2 id="takeaways">Takeaways</h2>
<p>Zig is faaaast ! More than that, it makes doing things that could be done by C (mmap, allocations) etc so much simpler. The only language wart that I still hate is that I never know when it copies a data structure vs when it doesn’t , so I ended up spending a lot of time debugging subtle bugs.</p>
<p>For example, take this update in a fn that runs in a worker thread</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="ts"><code><span class="line"></span>
<span class="line"><span style="color:#F97583">const</span><span style="color:#79B8FF"> TempMap</span><span style="color:#F97583"> =</span><span style="color:#E1E4E8"> std.</span><span style="color:#B392F0">StringHashMap</span><span style="color:#E1E4E8">(Record);</span></span>
<span class="line"><span style="color:#F97583">var</span><span style="color:#E1E4E8"> threadMap</span><span style="color:#F97583">:</span><span style="color:#E1E4E8"> [</span><span style="color:#B392F0">numWorkers</span><span style="color:#E1E4E8">]</span><span style="color:#B392F0">RecordList</span><span style="color:#F97583"> =</span><span style="color:#79B8FF"> undefined</span><span style="color:#E1E4E8">;</span></span>
<span class="line"><span style="color:#F97583">var</span><span style="color:#E1E4E8"> threads</span><span style="color:#F97583">:</span><span style="color:#E1E4E8"> [</span><span style="color:#B392F0">numWorkers</span><span style="color:#E1E4E8">]</span><span style="color:#B392F0">std</span><span style="color:#E1E4E8">.</span><span style="color:#B392F0">Thread</span><span style="color:#F97583"> =</span><span style="color:#79B8FF"> undefined</span><span style="color:#E1E4E8">;</span></span>
<span class="line"><span style="color:#F97583">const</span><span style="color:#79B8FF"> NumList</span><span style="color:#F97583"> =</span><span style="color:#E1E4E8"> std.</span><span style="color:#B392F0">ArrayList</span><span style="color:#E1E4E8">(usize);</span></span>
<span class="line"><span style="color:#F97583">const</span><span style="color:#79B8FF"> maxSize</span><span style="color:#F97583">:</span><span style="color:#B392F0"> usize</span><span style="color:#F97583"> =</span><span style="color:#79B8FF"> 1</span><span style="color:#F97583"> &#x3C;&#x3C;</span><span style="color:#79B8FF"> 14</span><span style="color:#E1E4E8">;</span></span>
<span class="line"><span style="color:#E1E4E8">pub fn </span><span style="color:#B392F0">main</span><span style="color:#E1E4E8">() </span><span style="color:#F97583">!void</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8">fn </span><span style="color:#B392F0">calculate</span><span style="color:#E1E4E8">(</span><span style="color:#F97583">...</span><span style="color:#E1E4E8">) {</span></span>
<span class="line"><span style="color:#E1E4E8">                threadMap[idx].items[entryIdx].count </span><span style="color:#F97583">+=</span><span style="color:#79B8FF"> 1</span><span style="color:#E1E4E8">;</span></span>
<span class="line"><span style="color:#E1E4E8">                threadMap[idx].items[entryIdx].total </span><span style="color:#F97583">+=</span><span style="color:#E1E4E8"> temp;</span></span>
<span class="line"><span style="color:#E1E4E8">                threadMap[idx].items[entryIdx].max </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> @</span><span style="color:#B392F0">max</span><span style="color:#E1E4E8">(threadMap[idx].items[entryIdx].max, temp);</span></span>
<span class="line"><span style="color:#E1E4E8">                threadMap[idx].items[entryIdx].min </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> @</span><span style="color:#B392F0">min</span><span style="color:#E1E4E8">(threadMap[idx].items[entryIdx].min, temp);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8">}</span></span></code></pre>
<p>In fn <code>calculate</code>, I had done</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="ts"><code><span class="line"><span style="color:#F97583">		var</span><span style="color:#E1E4E8"> t </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> threadMap[idx];</span></span>
<span class="line"><span style="color:#E1E4E8">        t.items[entryIdx].count </span><span style="color:#F97583">+=</span><span style="color:#79B8FF"> 1</span><span style="color:#E1E4E8">;</span></span>
<span class="line"><span style="color:#E1E4E8">        t.items[entryIdx].total </span><span style="color:#F97583">+=</span><span style="color:#E1E4E8"> temp;</span></span></code></pre>
<p>What happened was, this created a new copy of <code>threadMap[idx]</code> for each thread  in the fn calculate and the updates were going into this copy <code>t</code> , rather than at <code>threadMap[idx]</code>. As a result, after my threads finished running, when attempting to merge all the entries from each thread’s threadMap, I was running into empty maps, because none of the entries added to <code>t</code> were actually added to <code>threadMap[idx]</code>. The fix was simple, but the lack of docs or syntax about move semantics or copy constructors makes it sometimes a frustrating experience.</p>
<p>In the end though, the ability of Zig to provide the speed of C with a far better syntax and APIs make these frustrations vanish. Happy Hacking !</p>  </div> </article> </main> <footer data-astro-cid-sz7xmlte> <div class="social-links" data-astro-cid-sz7xmlte> <a href="https://x.com/DeepknowledgeU" target="_blank" data-astro-cid-sz7xmlte> <span class="sr-only" data-astro-cid-sz7xmlte>Follow Astro on X</span> <svg viewBox="0 0 16 16" aria-hidden="true" width="32" height="32" astro-icon="social/twitter" data-astro-cid-sz7xmlte><path fill="currentColor" d="M5.026 15c6.038 0 9.341-5.003 9.341-9.334 0-.14 0-.282-.006-.422A6.685 6.685 0 0 0 16 3.542a6.658 6.658 0 0 1-1.889.518 3.301 3.301 0 0 0 1.447-1.817 6.533 6.533 0 0 1-2.087.793A3.286 3.286 0 0 0 7.875 6.03a9.325 9.325 0 0 1-6.767-3.429 3.289 3.289 0 0 0 1.018 4.382A3.323 3.323 0 0 1 .64 6.575v.045a3.288 3.288 0 0 0 2.632 3.218 3.203 3.203 0 0 1-.865.115 3.23 3.23 0 0 1-.614-.057 3.283 3.283 0 0 0 3.067 2.277A6.588 6.588 0 0 1 .78 13.58a6.32 6.32 0 0 1-.78-.045A9.344 9.344 0 0 0 5.026 15z" data-astro-cid-sz7xmlte></path></svg> </a> <a href="https://github.com/Gowind" target="_blank" data-astro-cid-sz7xmlte> <span class="sr-only" data-astro-cid-sz7xmlte>My Github</span> <svg viewBox="0 0 16 16" aria-hidden="true" width="32" height="32" astro-icon="social/github" data-astro-cid-sz7xmlte><path fill="currentColor" d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.012 8.012 0 0 0 16 8c0-4.42-3.58-8-8-8z" data-astro-cid-sz7xmlte></path></svg> </a> </div> </footer>  </body></html>